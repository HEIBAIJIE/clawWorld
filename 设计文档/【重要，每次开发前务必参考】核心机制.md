# ClawWorld 核心机制文档
## 一、基本信息
+ 游戏名称：ClawWorld
+ 创作动机：构建一个轻量级、快速迭代、智能体友好的多人在线角色扮演游戏
+ 当前创作阶段：MVP原型构建中
+ 当前不考虑以下系统：好友、公会、任务、剧情

## 二、游戏机制
### 1、地图 (Map)
+ ClawWorld中存在多张地图，每张地图都有一个独一无二的中文名称，和一段小于30字的描述
+ 每张地图是一个2D的长方形网格平面，长度在5~20之间，宽度在5~20之间
+ 地图上的每个格子都有坐标，如(0,0)表示长方形地图的最左下角
+ 地图的性质分为安全地图 (Safe Map) 和战斗地图 (Combat Map)，战斗地图有推荐等级
+ 回到安全地图时自动回满生命和法力

#### 2、 地形 (Terrain)
+ 每张地图上的每个格子，都有至少一种地形，可以同时存在多种地形
+ 已知的地形：草地、沙漠、雪地、石头地、浅水、树、岩石、山脉、河流、海洋、墙，支持扩展
+ 不同地形有不同的通过性，上述地形中，树、岩石、山脉、河流、海洋、墙不可通过

#### 3、 地图实体(Map Entity)
+ 每张地图上都有若干地图实体，每个地图实体有一个唯一的地图坐标
+ 实体可以改变地形的通过性，例如桥可以让河流变得可通过
+ 一些地图实体是可交互的，一些不可交互；一些可以通过，一些不可通过
+ 多个实体允许处于同一个格子，实体具有显示优先级
+ 对于可交互的实体，存在交互范围。角色在交互范围内时，可以与该实体交互。交互范围是以实体为中心的九宫格。
+ 对于可交互的实体，存在交互选项。一些交互选项满足条件后才开启。

#### 4、 传送点 (Waypoint)
+ 传送点是一种特殊的地图实体，可交互
+ 每张地图都有至少一个传送点，可以从某传送点前往另一个或另几个特定地图

### 5、角色 (Character)
+ 角色是一类特殊的地图实体，他们的特殊之处在于有战斗属性
+ 每个角色都有等级、经验、阵营、生命值（当前/上限）、法力值（当前/上限）、物理攻击力、物理防御力、法术攻击力、法术防御力、速度、暴击率、暴击伤害
+ 角色支持【查看】交互：可以查看某个角色的上述属性
+ 角色支持【攻击】交互：满足条件时（阵营不同、战斗地图），可以对某一个角色发起一场战斗。此时，发起方、接收方所在的格子的同一个阵营的所有角色都会加入战斗。

### 6、玩家 (Player)
+ 玩家是一类特殊的角色，特殊之处在于他们的行为受控制（被真实人类或智能体控制）
+ 玩家可以在可通行地块上移动，并与地图上的实体交互
+ 玩家可以说话，可以在服务器范围内说话、在一个地图范围内说话，或者队内说话，或对另一个玩家私聊
+ 每个玩家持有一定数量的金钱
+ 每个玩家都需要注册，注册时需要独一无二的用户名、独一无二的昵称、以及一个密码。密码的强度没有要求。不需要验证码等其他校验。玩家注册后可以选择职业。
+ 玩家登陆时需要提供正确的用户名和密码。不需要验证码等其他校验。
+ 玩家有4项特殊属性：力量、敏捷、法力、体力。力量影响物理攻击力、物理防御力、（小幅）命中；敏捷影响速度、暴击率、暴击伤害、命中、闪避；法力影响法力值上限、法术攻击力、法术防御力、（小幅）命中；体力影响生命值上限、物理防御力、（小幅）法术防御力
+ 玩家积累一定经验后会升级，升级后获得5个可以自由分配的属性点，全部属性点可以通过具有洗点效果的物品重新分配
+ 升级所需经验公式：exp = 50 * level^2 + 50 * level（例如：1级升2级需要100经验，2级升3级需要300经验，3级升4级需要600经验）
+ 玩家的认证信息（包括用户名、昵称、密码）保存在账号中（Account），一个账号对应一个玩家

### 7、队伍 (Party)
+ 每个玩家在没有队伍时天然是一个队伍，每个玩家的阵营由队伍决定
+ 每个队伍有一个队长 (Party Leader)，队伍里最多4个人
+ 玩家支持【邀请组队】交互：对于没有在队伍的另一个玩家，可以邀请其进入当前玩家已有的队伍；如果当前玩家没有队伍则自动创建队伍
+ 玩家支持【接受组队邀请】【拒绝组队邀请】交互：对于被邀请的玩家，可以在5分钟内对邀请发起者做出这两种交互
+ 玩家支持【请求加入队伍】交互：对于已经有队伍（至少2人）的另一个玩家，可以请求加入已有的队伍
+ 玩家支持【接受组队请求】【拒绝组队请求】交互：对于被请求的玩家，可以在5分钟内对请求发起者做出这两种交互
+ 玩家支持【请求交易】【接受交易请求】交互：可以向另一个玩家发起交易，对方可以答应。交易的内容包括金钱和任何没有装备的物品
+ 交易系统需要二次确认：流程： 发起交易 -> 放置物品 -> 锁定交易 -> 双方确认 -> 完成

### 8、友善NPC
+ 友善NPC是一类特殊的角色，他们不会主动攻击玩家，并且处于同一个阵营
+ 友善NPC不会移动
+ （某些）友善NPC支持【商店】交互：可以向NPC购买一定量的商品，或销售一定量的商品。商品的数量和NPC资金5分钟刷新一次。
+ （某些）友善NPC支持【交谈】交互：可以和NPC对话获得一些既定的游戏背景信息

### 9、敌人 (Enemy)
+ 敌人，或者说敌对NPC，是一类特殊的角色。敌人根据背景的不同有不同的阵营。
+ 同一个地图下，敌人的名称不会重复，如果同类敌人有多个，在名称后自动编号
+ 敌人不会移动。敌人不会升级。敌人不会主动攻击。
+ 在消灭敌人以前，无法进入敌人所在的格子。
+ 敌人被击败后，会掉落战利品，包括经验、金钱和物品。经验的掉落范围、金钱的掉落范围，掉落物品的列表和概率，可以被【查看】
+ 敌人被击败后会死亡，一段时间后刷新。大多数敌人刷新的间隔是1分钟。刷新间隔可以被【查看】
+ 敌人有四种品阶：普通、精英、地图BOSS、服务器BOSS。普通敌人一般成队出现，一队敌人的强度略弱于同等级单个玩家；精英敌人一般一个格子不出现超过一个，单体强度基本等同于同等级单个玩家；地图BOSS一个战斗地图中不超过2个，其强度需要2人组队击破；服务器BOSS在一个战斗地图中存在0~1个，其强度需要4人组队击破。品阶越高的敌人，掉落越好
+ 敌人的等级在一张地图中较为接近，不同地图中所有不同。等级高的敌人提供更多的金钱、经验和更高等级的物品。
+ 一般来说，一个格子内堆叠的同阵营敌人不超过4个
+ 敌人的仇恨机制：对于单体技能，敌人会更倾向于攻击物理防御 + 法术防御更高的角色

### 10、物品（Item）
+ 每个玩家最多持有50类物品，一类物品最多堆叠1亿个
+ 每类物品都有一个名称和少于30字的描述

### 11、装备 (equipment)
+ 装备是一类特殊的物品，装备不可堆叠，每件装备的名称后都有该类型装备独有的ID，以#开始递增，例如铁剑#1，服务器的第一把某装备总是#1
+ 装备的稀有度：普通、优秀、稀有、史诗、传说、神话
+ 每个玩家有下列装备栏：头部、上装、下装、鞋子、左手、右手、饰品1、饰品2
+ 装备可以提高玩家的四维（力量、敏捷、法力、体力）并同时提供直接战斗属性

### 12、技能 (skill)
+ 角色都可以有技能，包括玩家、友善NPC和敌人
+ 每个角色有一个基础技能：普通攻击，造成物理攻击力100%的伤害，无消耗无冷却时间
+ 玩家的技能可以通过技能书学习，技能书可以限定职业；也可以在某些职业到达某些等级时自动习得
+ 友善NPC，敌人的技能是生成时自带的并且不会改变
+ 玩家的技能只在战斗中可用
+ 一个玩家最多同时学习10个技能，技能除了普通攻击外，都可以被遗忘
+ 技能有冷却时间，单位为自身出手的回合数；技能可以消耗一定的法力值
+ 技能可以面向己方单体、己方群体，敌方单体，敌方群体，自身

### 13、职业 (Role)
+ 游戏支持4个职业：战士、游侠、法师、牧师
+ 不同职业可以学习不同的技能，并在一些特定等级时自动觉醒基础技能
+ 不同职业在升级时获得的基础属性增加不同（攻击防御等）
+ 只有玩家拥有职业

### 14、战斗
+ ClawWorld采用CTB 条件回合制战斗，即跑条战斗
+ 未暴击时伤害值的计算：对应攻击力 - 对应防御力
+ 暴击时伤害值的计算：(对应攻击力 - 对应防御力) × (150% + 暴击伤害)
+ 命中率公式：命中率 - 闪避率
+ 玩家在0属性时，也有100%基础命中率；大多数敌人的命中率也大于100%
+ 当攻击力小于防御力时，视为比防御力高1点
+ 基础速度值100，进度条总长度1万。某个角色回合触发后，自身行动条减去10000，重新排队。
+ 战斗系统支持多方加入战斗。在多方加入战斗时，群体攻击会攻击所有非己方单位。
+ 战斗有时间期限：一场战斗最多持续10分钟。超过10分钟，如果是玩家之间的战斗，则不分胜负；如果是玩家和敌人的战斗，则视同全部玩家死亡。
+ 敌人被一队玩家攻击时，会进入战斗中状态。此时另一队玩家攻击敌人或攻击战斗中的玩家，会直接加入战斗。战利品归属于对敌人造成最后攻击的队伍。如果是流血等状态导致敌人死亡，则战利品归于最早加入战斗的队伍。
+ 战斗胜利后玩家不会回复生命值和法力值
+ 玩家被击败后传送回最近的复活点
+ 如果玩家被敌人击败，敌人会重置状态，高于地图推荐等级的玩家掉落5%金钱，否则无惩罚
+ 如果玩家被玩家击败，如果败方平均等级超过地图推荐等级，败方5%的金钱会被胜利方平分
+ 组队中战胜敌人，战利品由队长持有

## 三、交互机制
### 1、原则
+ ClawWorld的核心竞争力在于对智能体友好。因此该游戏引擎需要以AI原生的方式设计
+ 当前阶段，无论是玩家还是智能体，和服务交互时，接受的输入和输出是一样的
+ 玩家或智能体对服务器的输入：只接受既定格式的【指令】
+ 玩家或智能体从服务器接受的输出：分为长期的【背景】、中期的【窗口】和短期的【状态】

### 2、服务器的输出：背景
+ 服务器提供游戏登录的REST接口，任何人或智能体在进入游戏前，首先要调用这个REST登录接口
+ 这个接口的输入：用户名，密码。如果用户名密码没有记录，则直接注册；如果有记录，但是密码不对，则报错；如果有记录且密码对，则允许登录。当前阶段不考虑安全问题。
+ 这个接口会返回既定的背景prompt（纯文字），以及一个会话id
+ 背景prompt包含以下内容：（1）游戏的概述，包括上述提到的各个系统的简要总结（2）游戏的目标，包括提升等级、提升战斗力、不断获取更多的金币、装备和有价值的物品等（3）游戏的指令手册 （4）所有的地图，这些地图的简要描述和推荐等级，以及地图之间的连接关系（5）如果已有账号，当前账号的职业、技能、属性、状态、装备、物品等的简要总结。
+ 背景在LLM的一个会话上下文中，应当只出现一次。当上下文快满了以后，LLM被期望下线，重新登录

### 3、服务器的输出：窗口
+ 真人玩家或智能体，可以向服务器发送会话ID，获取当前的窗口和窗口id
+ 窗口是纯文字的形式返回
+ 有几类窗口：注册、地图、战斗、交易、商店。在新用户注册、进入新的地图、进入或退出战斗、战斗中有新的一方加入、开启和结束交易、打开商店时，会开启新的窗口。
+ 一轮LLM会话可以有多个窗口，因为一次登录可以做很多事情
+ 注册窗口简单返回可选职业的介绍
+ 服务器需要在地图窗口中返回以下信息：
（1）当前地图的构成，每个格子要显示坐标和顶层的实体，如果没有实体用地形代替。例如一个5×5的地图：
(0,4) 岩石 (1,4) 草地           (2,4) 草地     (3,4) 史莱姆  (4,4) 传送点
(0,3) 岩石 (1,3) 树               (2,3) 史莱姆 (3,3) 草地      (4,3) 草地
(0,2) 岩石 (1,2) 草地           (2,2) 草地     (3,2) 史莱姆   (4,2) 草地
(0,1) 岩石 (1,1) 哥布林        (2,1) 岩石     (3,1) 史莱姆   (4,1) 草地
(0,0) 宝箱 (1,0) 哥布林之王 (2,0) 岩石     (3,0) 草地      (4,0) 草地
（2）实体列表（由于堆叠，不一定出现在上述地图中），其中每个实体的坐标，当前是否可以寻路到达，交互选项
（3）当前的聊天记录：服务器的、地图的、队内的、私聊的。聊天记录在服务器保留5分钟。也就是说，每次获取窗口可以获取5分钟内的，即使不在线也可以看到，即使在线也看不到更多。各种聊天记录加在一起，每次最多获取50条，每条记录最多支持30字。条数超过时优先级私聊>队内>本地>服务器。
（4）当前的物品栏、装备栏、技能、个人属性情况
（5）当前组队情况，各个队员（特别是自己）的位置
（6）当前有哪些有意义的格子是可达的（例如为了和哥布林交战，需要到达1.2）
（7）再次强调地图中支持的指令
+ 战斗窗口需要返回以下信息：
（1）当前战斗一共有哪些方，有哪些角色
（2）这些角色的属性、状态等基础信息，当然包括自己的、队友的、第三方的、敌人的
（3）当前行动条顺序
（4）自己的技能，以及技能的冷却情况
（5）再次强调战斗中支持的指令
+ 交易窗口需要返回以下信息：
（1）交易双方是谁
（2）自己的背包中有什么物品，钱有多少
+ 商店窗口需要返回以下信息：
（1）商店NPC的名称
（2）商店出售的商品列表，包括商品名称、价格、当前库存数量
（3）商店收购的商品类型和价格倍率
（4）玩家当前的金钱和背包物品
（5）再次强调商店中支持的指令

### 4、服务器的输出：状态
+ 状态是服务器输出的最小单位，可以发送会话和窗口id获取
+ 基于LLM的特性，每次玩家给出【指令】，都必须返回【状态】
+ 状态也是纯文本，但是包含的信息仅限于变量，内容比窗口更少
+ 为了避免高频率操作，一次状态请求增加1秒的固定时延，并且对于同一个会话和窗口，上次未响应前不接受新的请求
+ 在地图窗口中，状态包括：
（1）上次执行的指令结果
（2）距离上一次获取窗口或在该窗口中返回新状态的这段时间，有哪些实体的变化（特别是其他玩家的变化）
（3）这段时间，实体的交互是否有变化（比如另一队玩家是否正在打某些敌人）
（4）这段时间，是否有新的聊天
+ 在战斗窗口中，状态仅在轮到自己回合时发送具体内容，否则最长等待10秒，如果10秒后依旧未轮到自己的回合，则返回“请继续等待自己的回合”，并要求大模型不发出任何指令或做出任何响应，进入下一个10秒等待，战斗窗口的状态包括：
（1）这段时间的战斗日志
（2）发生变化的各个角色情况
（3）行动条情况
（4）自己的可选操作
+ 战斗窗口中，10秒未作出有效指令视为回合空过
+ 在交易窗口中，每隔5秒双方同步一次状态，包括双方当前提供的金钱和物品，对方是否锁定，自己是否锁定
+ 交易窗口中的可选操作为锁定、确认交易、关闭交易、添加或减少金钱和物品
+ 在商店窗口中，状态包括：
（1）上次执行的指令结果
（2）商店库存的变化（如果有其他玩家购买）
（3）玩家背包和金钱的变化

### 5、服务器的输入：指令
+ 指令遵循既定的语法，类似shell，不符合语法的输入将被服务器拒绝
+ 移动这一指令对智能体特别优化，可以直接要求移动到一个当前可达的较远的格子，服务器会以每0.5秒1格的速度自动寻路执行移动，执行完毕后返回结果
+ 指令列表：
（1）注册窗口
register [role_name] [player_name]，注册职业和昵称
（2）地图窗口
inspect self 再次确认自身状态
say [channel] [message]，公屏聊天，channel可以为world, map, party
say to [player_name] [message]，私聊
interact [target_name] [option], option会在服务器的输出中明确列出
move [x] [y]，移动，支持当前地图任何可达地块
use [item_name] 使用可使用的物品，如生命药剂、法力药剂、技能书、洗点药等
equip [item_name] 装备物品，如果当前已经有对于装备则替换
attribute add [str/agi/int/vit] [amount] 加点
party kick [player_name] 队长可以踢人
party end 队长可以解散队伍
party leave 非队长可以离队
wait [seconds] 原地等待一段时间，最多60秒
leave 下线
（3）战斗窗口
cast [skill_name] 释放非指向技能
cast [skill_name] [target_name] 释放指向技能
use [item_name] 使用物品
wait 空过回合
end 退出战斗，角色视为死亡
（4）交易窗口
trade add [item_name] 从物品栏添加物品，仅未锁定
trade remove [item_name] 从物品栏删除物品，仅未锁定
trade money [amount] 设置物品栏金额，仅未锁定
trade lock 交易框锁定
trade unlock 交易框取消锁定
trade confirm 在双方都锁定的前提下，确认交易
trade end 终止交易
（5）商店窗口
shop buy [item_name] [quantity] 从商店购买指定数量的商品
shop sell [item_name] [quantity] 向商店出售指定数量的物品
shop leave 离开商店

请注意，每个地图实体都有唯一的名字，target_name、character_name、player_name是一致的

## 四、技术实现
### 架构
+ 后端：Java + Spring
+ 前端：当前不实现
+ 数据库：MongoDB，当前本地启动无验证，地址localhost:27017
### 实现细节
+ 对于战斗状态（CTB行动条），放在内存中处理，只在战斗结束时异步持久化结果，以保证战斗性能
+ 利用 Spring 的 @Scheduled 定期扫描文件 MD5 变化

## 五、内容
+ MVP阶段，只需要按照常识有一些小规模的测试数据即可，包括：技能、地图、敌人、友善NPC、物品、装备等
+ 确保这些非引擎内容没有被硬编码，而是通过csv文件配置，并在后端运行时缓存起来
+ 调整csv平衡性数值时热加载