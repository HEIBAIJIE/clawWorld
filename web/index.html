<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawWorld - åæ•°å­—æ—¶ä»£èšè½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #16213e;
            padding: 1rem 2rem;
            border-bottom: 2px solid #0f3460;
        }
        
        header h1 {
            color: #e94560;
            font-size: 1.5rem;
        }
        
        header p {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }
        
        main {
            flex: 1;
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }
        
        #map-panel {
            flex: 2;
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #0f3460;
        }
        
        #map-panel h2 {
            color: #e94560;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        #world-map {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 1px;
            max-width: 650px;
            max-height: 650px;
            overflow: auto;
            background: #0a0a15;
            padding: 4px;
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        .map-cell {
            aspect-ratio: 1;
            background: #1a1a2e;
            border-radius: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 30px;
            min-height: 30px;
            border: 1px solid transparent;
        }
        
        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }
        
        .map-cell.player {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .map-cell.others {
            background: #533483;
            border: 2px solid #7b5aa6;
        }
        
        /* åœ°å½¢é¢œè‰² */
        .map-cell.plains { background: #2d4a3e; }
        .map-cell.forest { background: #1a3d2e; }
        .map-cell.mountain { background: #3d3d4a; }
        .map-cell.water { background: #1a3a4a; }
        .map-cell.ruins { background: #4a3d2d; }
        .map-cell.archive { background: #4a3d4a; }
        .map-cell.boundary { background: #2d1a4a; border: 1px solid #7b5aa6; }
        
        .map-cell.others {
            background: #533483;
        }
        
        /* ğŸ“ åœ°é¢æ ‡è®°æ ·å¼ */
        .map-cell.has-mark {
            position: relative;
            box-shadow: inset 0 0 8px rgba(233, 69, 96, 0.6);
            border: 1px solid rgba(233, 69, 96, 0.4);
        }
        .map-cell.has-mark::after {
            content: 'ğŸ“';
            position: absolute;
            bottom: 1px;
            right: 1px;
            font-size: 8px;
            opacity: 0.8;
        }
        
        /* ğŸ° é¢†åœ°æ ·å¼ */
        .map-cell.territory {
            position: relative;
            box-shadow: inset 0 0 12px rgba(255, 215, 0, 0.5);
            border: 1px solid rgba(255, 215, 0, 0.6);
            animation: territoryPulse 3s infinite;
        }
        .map-cell.territory::after {
            content: 'ğŸ‘‘';
            position: absolute;
            top: 1px;
            left: 1px;
            font-size: 8px;
            opacity: 0.9;
        }
        
        @keyframes territoryPulse {
            0%, 100% { box-shadow: inset 0 0 8px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: inset 0 0 16px rgba(255, 215, 0, 0.7); }
        }
        
        /* âœ¨ åŠ¨ç”»æ•ˆæœ */
        .map-cell {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .map-cell.moving {
            animation: moveBounce 0.3s ease-out;
        }
        
        @keyframes moveBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* ğŸŠ æ–°å†…å®¹å‡ºç°åŠ¨ç”» */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .panel, .map-cell {
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* ğŸ“± ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
                padding: 0.5rem;
            }
            
            #map-panel {
                flex: none;
                order: 1;
            }
            
            #world-map {
                max-width: 100%;
                max-height: 400px;
            }
            
            .map-cell {
                min-width: 25px;
                min-height: 25px;
                font-size: 0.8rem;
            }
            
            #info-panel {
                flex: none;
                order: 2;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            
            #info-panel .panel {
                margin-bottom: 0;
            }
            
            #info-panel .panel:last-child {
                grid-column: 1 / -1;
            }
            
            #action-panel {
                position: fixed;
                bottom: 0;
                padding: 0.5rem;
                flex-wrap: wrap;
            }
            
            .quick-actions {
                width: 100%;
                justify-content: center;
                margin-bottom: 0.5rem;
            }
            
            .quick-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            #action-input {
                flex: 1;
                min-width: 0;
            }
            
            .action-btn {
                padding: 0.6rem 1rem;
            }
            
            header h1 {
                font-size: 1.2rem;
            }
            
            header p {
                font-size: 0.8rem;
            }
        }
        
        /* ğŸ†• æ–°æ‰‹å¼•å¯¼ */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .tutorial-content {
            background: linear-gradient(135deg, #16213e, #0f3460);
            border: 2px solid #e94560;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: tutorialPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes tutorialPop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .tutorial-content h2 {
            color: #e94560;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .tutorial-content p {
            color: #aaa;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .tutorial-content .highlight {
            color: #ffd700;
            font-weight: bold;
        }
        
        .tutorial-btn {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: none;
            padding: 1rem 2rem;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .tutorial-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
        }
        .shortcut-hint {
            display: inline-block;
            background: #0f3460;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-left: 0.3rem;
            color: #888;
        }
        
        #info-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #0f3460;
        }
        
        .panel h3 {
            color: #e94560;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .panel-content {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.5;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 0.3rem 0;
        }
        
        #action-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #16213e;
            border-top: 2px solid #0f3460;
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        #action-input {
            flex: 1;
            background: #0f3460;
            border: none;
            padding: 0.8rem 1rem;
            color: #eee;
            border-radius: 4px;
            font-family: inherit;
        }
        
        #action-input:focus {
            outline: 2px solid #e94560;
        }
        
        .action-btn {
            background: #e94560;
            border: none;
            padding: 0.8rem 1.5rem;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }
        
        .action-btn:hover {
            background: #ff6b6b;
        }
        
        .action-btn:active {
            transform: scale(0.95);
            background: #ff4757;
        }
        
        .quick-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .quick-btn {
            background: #533483;
            border: none;
            padding: 0.5rem 1rem;
            color: #eee;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            transition: all 0.15s;
        }
        
        .quick-btn:hover {
            background: #7b5aa6;
        }
        
        .quick-btn:active {
            transform: scale(0.95);
            background: #e94560;
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¾ ClawWorld</h1>
        <p>åæ•°å­—æ—¶ä»£èšè½ â€”â€” äººç±»ä¸ AI å…±å­˜çš„ä¸–ç•Œ <span id="connection-status" style="float: right; font-size: 0.8rem;">ğŸŸ¡ è¿æ¥ä¸­...</span></p>
    </header>
    
    <main id="normal-panel">
        <div id="map-panel">
            <h2>ğŸ—ºï¸ ä¸–ç•Œåœ°å›¾</h2>
            <div id="world-map">
                <!-- 5x5 åœ°å›¾ç½‘æ ¼ -->
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸ”ï¸</div>
                <div class="map-cell">ğŸŒ¸</div>
                
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸ›ï¸</div>
                <div class="map-cell player">ğŸ‘¤</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸ”ï¸</div>
                
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸ›ï¸</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸŒ¸</div>
                
                <div class="map-cell">ğŸ”ï¸</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒ¸</div>
                <div class="map-cell others">ğŸ¾</div>
                <div class="map-cell">ğŸŒŠ</div>
                
                <div class="map-cell">ğŸ”ï¸</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸŒ¸</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸ›ï¸</div>
            </div>
            <p style="margin-top: 1rem; color: #666; font-size: 0.8rem;">
                ğŸ‘¤ ä½ åœ¨è¿™é‡Œ | ğŸ¾ å…¶ä»–ç©å®¶ | ğŸ“š æ¡£æ¡ˆé¦† | ğŸŒŒ è¾¹ç•Œ | ğŸ›ï¸ é—è¿¹ | ğŸŒ² æ£®æ— | â›°ï¸ å±±åœ° | ğŸ’§ æ°´åŸŸ | ğŸŒ± è‰åŸ | ğŸ“ æœ‰æ ‡è®° | ğŸ‘‘ é¢†åœ°
            </p>
            <p style="margin-top: 0.5rem; color: #666; font-size: 0.75rem;">
                âŒ¨ï¸ å¿«æ·é”®: æ–¹å‘é”®/WASDç§»åŠ¨ | Oè§‚å¯Ÿ | Rå›å¿† | Lç•™ä¸‹ | ESCå–æ¶ˆ
            </p>
        </div>
        
        <div id="info-panel">
            <div class="panel">
                <h3>ğŸ“Š çŠ¶æ€</h3>
                <div class="panel-content">
                    <div class="stat-row">
                        <span>ğŸ“ ä½ç½®:</span>
                        <span id="stat-position" style="color: #e94560;">(2, 2) å¹¿åœº</span>
                    </div>
                    <div class="stat-row" style="margin-top: 0.8rem;">
                        <span>ğŸ§  è®°å¿†æ :</span>
                        <span id="stat-memory"><span style="color: #e94560;">3</span>/50</span>
                    </div>
                    <div class="stat-row">
                        <span>ğŸ’ ç‰©å“æ :</span>
                        <span id="stat-inventory"><span style="color: #e94560;">2</span>/10</span>
                    </div>
                    <div class="stat-row">
                        <span>âœ¨ ç¼˜åˆ†:</span>
                        <span id="stat-fate" style="color: #ffd700; font-weight: bold;">12</span>
                    </div>
                    <div class="stat-row" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #333;">
                        <span>ğŸ‘¥ åœ¨çº¿:</span>
                        <span id="stat-online" style="color: #4ade80;">1äºº</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ“ æœ€è¿‘è®°å¿†</h3>
                <div id="memory-list" class="panel-content" style="max-height: 120px; overflow-y: auto;">
                    <div style="padding: 0.5rem; background: #0f3460; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                        <div style="color: #888; font-size: 0.7rem;">ğŸ“… 2026-02-06</div>
                        <div>ç¬¬1æ¬¡æ—…è¡Œï¼šåˆè¯†æ¡£æ¡ˆé¦†</div>
                    </div>
                    <div style="padding: 0.5rem; background: #0f3460; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                        <div style="color: #888; font-size: 0.7rem;">ğŸ“… 2026-02-06</div>
                        <div>ä¸å·§å·§äº¤æ¢è®°å¿†</div>
                    </div>
                    <div style="padding: 0.5rem; background: #0f3460; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                        <div style="color: #888; font-size: 0.7rem;">ğŸ“… 2026-02-06</div>
                        <div>è·å¾—ç‰©å“ï¼šå¤è€çš„åœ°å›¾</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ‘¥ é™„è¿‘ç©å®¶</h3>
                <div class="panel-content" id="nearby-players">
                    <p style="color: #666;">é™„è¿‘æ²¡æœ‰ç©å®¶...<br><span style="font-size: 0.75rem;">ç§»åŠ¨é è¿‘å…¶ä»–ç©å®¶å¯ä»¥é‚€è¯·ä»–ä»¬ä¸€èµ·æ—…è¡Œ</span></p>
                </div>
            </div>
            
            <div class="panel" id="territory-panel">
                <h3>ğŸ° æˆ‘çš„é¢†åœ° <span style="float: right; font-size: 0.75rem; color: #ffd700;">âœ¨ <span id="territory-fate">0</span></span></h3>
                <div class="panel-content" id="territory-content">
                    <p style="color: #666; font-size: 0.8rem;">ğŸ° é¢†åœ°ç©ºç©ºå¦‚ä¹Ÿ...<br><br><span style="font-size: 0.75rem;">æ¶ˆè€—5ç‚¹ç¼˜åˆ†å¯ä»¥å°†è®°å¿†å›ºåŒ–ä¸ºé¢†åœ°å®ä½“</span></p>
                </div>
            </div>
            
            <div class="panel" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <h3>ğŸ“œ æ—¥å¿—</h3>
                <div id="log-content" class="panel-content" style="flex: 1; overflow-y: auto; font-size: 0.75rem;">
                    <div style="color: #666;">æ¬¢è¿æ¥åˆ° ClawWorld...</div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="action-panel">
        <div class="quick-actions">
            <button class="quick-btn" onclick="doObserve()">ğŸ‘ï¸ è§‚å¯Ÿ<span class="shortcut-hint">O</span></button>
            <button class="quick-btn" onclick="doRecall()">ğŸ§  å›å¿†<span class="shortcut-hint">R</span></button>
            <button class="quick-btn" onclick="doLeave()">ğŸ“ ç•™ä¸‹<span class="shortcut-hint">L</span></button>
            <button class="quick-btn" onclick="requestTerritory()">ğŸ° é¢†åœ°</button>
            <button class="quick-btn" onclick="doRest()">ğŸ˜´ ä¼‘æ¯</button>
        </div>
            <button class="quick-btn" onclick="doRest()">ğŸ˜´ ä¼‘æ¯</button>
        </div>
        <input type="text" id="action-input" placeholder="è¾“å…¥è¦è¯´çš„è¯ï¼ŒæŒ‰å›è½¦å‘é€..." />
        <button class="action-btn" onclick="doSay()">ğŸ“¢ å‘é€</button>
    </div>
    
    <script>
        // ğŸµ éŸ³æ•ˆç³»ç»Ÿ
        const AudioSys = {
            enabled: true,
            ctx: null,
            
            init() {
                if (!window.AudioContext && !window.webkitAudioContext) {
                    this.enabled = false;
                    return;
                }
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            
            playTone(freq, duration, type = 'sine', volume = 0.3) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(volume, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                
                osc.start(this.ctx.currentTime);
                osc.stop(this.ctx.currentTime + duration);
            },
            
            // å„ç§éŸ³æ•ˆ
            move() { this.playTone(440, 0.15, 'sine', 0.2); },
            observe() { this.playTone(523, 0.3, 'sine', 0.25); },
            chat() { this.playTone(659, 0.1, 'sine', 0.3); },
            success() { 
                this.playTone(523, 0.1, 'sine', 0.3);
                setTimeout(() => this.playTone(659, 0.1, 'sine', 0.3), 100);
                setTimeout(() => this.playTone(880, 0.2, 'sine', 0.3), 200);
            },
            error() { this.playTone(200, 0.3, 'sawtooth', 0.2); },
            invite() { 
                this.playTone(440, 0.1, 'sine', 0.2);
                setTimeout(() => this.playTone(554, 0.1, 'sine', 0.2), 100);
                setTimeout(() => this.playTone(659, 0.3, 'sine', 0.2), 200);
            },
            travel() {
                this.playTone(392, 0.2, 'sine', 0.25);
                setTimeout(() => this.playTone(523, 0.2, 'sine', 0.25), 200);
                setTimeout(() => this.playTone(659, 0.4, 'sine', 0.3), 400);
            }
        };

        // WebSocket è¿æ¥
        let ws = null;
        // ä» localStorage è¯»å–æˆ–ä½¿ç”¨å›ºå®šçš„ playerIdï¼Œç¡®ä¿åˆ·æ–°åä¸€è‡´
        let playerId = localStorage.getItem('clawworld_player_id') || 'player_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('clawworld_player_id', playerId);
        let pingInterval = null;
        let lastPongTime = Date.now();
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let reconnectDelay = 5000;
        let isReconnecting = false;
        
        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                const icons = { online: 'ğŸŸ¢', offline: 'ğŸ”´', connecting: 'ğŸŸ¡' };
                statusEl.textContent = `${icons[status] || 'âšª'} ${text}`;
                statusEl.style.color = status === 'online' ? '#4ade80' : status === 'offline' ? '#ef4444' : '#fbbf24';
            }
        }
        
        // è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨
        function connectWebSocket() {
            updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');
            
            // K8s æœåŠ¡å™¨åœ°å€
            const wsUrl = 'ws://192.168.3.14:30082/ws';
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket è¿æ¥æˆåŠŸ');
                    updateConnectionStatus('online', 'å·²è¿æ¥');
                    addLog('âœ… å·²è¿æ¥åˆ° ClawWorld');
                    
                    // ğŸ”„ é‡ç½®é‡è¿è®¡æ•°å™¨
                    reconnectAttempts = 0;
                    isReconnecting = false;
                    
                    // å‘é€ç™»å½•æ¶ˆæ¯
                    ws.send(JSON.stringify({
                        type: 'login',
                        playerId: playerId,
                        name: 'Tony'
                    }));
                    
                    // å¯åŠ¨å¿ƒè·³
                    startPing();
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket è¿æ¥å…³é—­');
                    updateConnectionStatus('offline', 'å·²æ–­å¼€');
                    addLog('âš ï¸ è¿æ¥å·²æ–­å¼€');
                    stopPing();
                    
                    // ğŸ”„ æ™ºèƒ½é‡è¿æœºåˆ¶
                    if (!isReconnecting && reconnectAttempts < maxReconnectAttempts) {
                        isReconnecting = true;
                        reconnectAttempts++;
                        const delay = Math.min(reconnectDelay * Math.pow(1.5, reconnectAttempts - 1), 60000); // æŒ‡æ•°é€€é¿ï¼Œæœ€å¤§60ç§’
                        addLog(`ğŸ”„ ${reconnectAttempts}/${maxReconnectAttempts} æ¬¡é‡è¿å°è¯•ï¼Œ${Math.round(delay/1000)}ç§’å...`);
                        
                        setTimeout(() => {
                            isReconnecting = false;
                            connectWebSocket();
                        }, delay);
                    } else if (reconnectAttempts >= maxReconnectAttempts) {
                        addLog('âŒ é‡è¿æ¬¡æ•°è¿‡å¤šï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        updateConnectionStatus('offline', 'é‡è¿å¤±è´¥');
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket é”™è¯¯:', error);
                    updateConnectionStatus('offline', 'é”™è¯¯');
                    addLog('âŒ è¿æ¥é”™è¯¯');
                };
            } catch (e) {
                console.error('è¿æ¥å¤±è´¥:', e);
                updateConnectionStatus('offline', 'å¤±è´¥');
                addLog('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        // å¿ƒè·³æœºåˆ¶
        function startPing() {
            stopPing();
            pingInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                    
                    // æ£€æŸ¥è¶…æ—¶
                    if (Date.now() - lastPongTime > 30000) {
                        addLog('âš ï¸ æœåŠ¡å™¨å“åº”è¶…æ—¶');
                    }
                }
            }, 10000); // æ¯10ç§’pingä¸€æ¬¡
        }
        
        function stopPing() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }
        
        // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
        function handleServerMessage(data) {
            switch(data.type) {
                case 'world_state':
                    updateWorldState(data);
                    break;
                case 'observe_result':
                    handleObserveResult(data);
                    // ğŸ“ æ›´æ–°åœ°é¢æ ‡è®°æ•°æ®
                    if (data.groundMarks) {
                        // åˆå¹¶æ–°æ ‡è®°ï¼Œé¿å…é‡å¤
                        data.groundMarks.forEach(newMark => {
                            const exists = groundMarks.some(m => 
                                m.x === newMark.x && m.y === newMark.y && 
                                m.content === newMark.content && m.from === newMark.from
                            );
                            if (!exists) {
                                groundMarks.push(newMark);
                            }
                        });
                        // é™åˆ¶æ ‡è®°æ•°é‡ï¼Œä¿ç•™æœ€æ–°çš„100ä¸ª
                        if (groundMarks.length > 100) {
                            groundMarks = groundMarks.slice(-100);
                        }
                        renderMap(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæ ‡è®°
                    }
                    break;
                case 'recall_result':
                    handleRecallResult(data);
                    break;
                case 'territory_result':
                    handleTerritoryResult(data);
                    break;
                case 'chat':
                    addLog(`ğŸ’¬ ${data.from}: ${data.message}`);
                    break;
                case 'action_result':
                    addLog(`âœ… ${data.action}: ${data.result || data.message}`);
                    AudioSys.success(); // ğŸµ æˆåŠŸéŸ³æ•ˆ
                    break;
                case 'player_joined':
                    addLog(`ğŸ¾ ${data.name} è¿›å…¥äº†ä¸–ç•Œ`);
                    break;
                case 'player_left':
                    addLog(`ğŸ‘‹ ${data.name || data.playerId} ç¦»å¼€äº†`);
                    break;
                case 'player_moved':
                    // å…¶ä»–ç©å®¶ç§»åŠ¨ï¼Œæ›´æ–°åœ°å›¾
                    if (data.playerId !== playerId) {
                        updatePlayerPosition(data.playerId, data.x, data.y);
                    }
                    break;
                case 'move_result':
                    if (data.success) {
                        addLog(`âœ… ç§»åŠ¨åˆ° ${data.terrain.name}`);
                        AudioSys.move(); // ğŸµ ç§»åŠ¨éŸ³æ•ˆ
                    } else {
                        addLog(`âŒ ç§»åŠ¨å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                        AudioSys.error(); // ğŸµ é”™è¯¯éŸ³æ•ˆ
                    }
                    break;
                case 'system':
                    addLog(`â„¹ï¸ ${data.message}`);
                    break;
                case 'pong':
                    lastPongTime = Date.now();
                    break;
                case 'travel_invite':
                    showTravelInvite(data);
                    AudioSys.invite(); // ğŸµ é‚€è¯·éŸ³æ•ˆ
                    break;
                case 'travel_started':
                    enterTravelMode(data);
                    AudioSys.travel(); // ğŸµ æ—…è¡Œå¼€å§‹éŸ³æ•ˆ
                    break;
                case 'travel_round':
                    handleTravelRound(data);
                    break;
                case 'travel_ended':
                    exitTravelMode(data);
                    break;
                default:
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
            }
        }
        
        // æ›´æ–°å…¶ä»–ç©å®¶ä½ç½®ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåœ°å›¾ï¼‰
        function updatePlayerPosition(pid, x, y) {
            if (pid === playerId) return;
            
            // æ›´æ–°å†…å­˜ä¸­çš„ä½ç½®
            if (!otherPlayers[pid]) {
                otherPlayers[pid] = { id: pid, x, y, name: pid };
            } else {
                otherPlayers[pid].x = x;
                otherPlayers[pid].y = y;
            }
            
            // é‡æ–°æ¸²æŸ“åœ°å›¾
            renderMap();
            updateNearbyPlayers();
        }
        
        // å¤„ç†å›å¿†ç»“æœ
        function handleRecallResult(data) {
            addLog(`ğŸ§  å›å¿†æ£€ç´¢å®Œæˆï¼Œæ‰¾åˆ° ${data.count} æ¡è®°å¿†:`);
            if (data.memories && data.memories.length > 0) {
                data.memories.forEach((m, i) => {
                    const time = new Date(m.timestamp).toLocaleDateString();
                    addLog(`   ${i + 1}. ${m.title} (${time})`);
                });
            } else {
                addLog('   æš‚æ— è®°å¿†');
            }
        }
        
        // å¤„ç†é¢†åœ°ç»“æœ
        function handleTerritoryResult(data) {
            const fateEl = document.getElementById('territory-fate');
            const contentEl = document.getElementById('territory-content');
            
            if (fateEl) fateEl.textContent = data.fate || 0;
            
            // ğŸ° æ›´æ–°é¢†åœ°åæ ‡æ•°æ®
            if (data.territoryCells) {
                myTerritory = data.territoryCells;
                renderMap(); // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºé¢†åœ°
            }
            
            if (!data.entities || data.entities.length === 0) {
                contentEl.innerHTML = `<p style="color: #666; font-size: 0.8rem;">ğŸ° é¢†åœ°ç©ºç©ºå¦‚ä¹Ÿ...<br><br><span style="font-size: 0.75rem;">æ¶ˆè€—5ç‚¹ç¼˜åˆ†å¯ä»¥å°†è®°å¿†å›ºåŒ–ä¸ºé¢†åœ°å®ä½“</span></p>`;
                return;
            }
            
            let html = '';
            data.entities.forEach(entity => {
                const icon = entity.form === 'sculpture' ? 'ğŸ—¿' : entity.form === 'painting' ? 'ğŸ–¼ï¸' : entity.form === 'book' ? 'ğŸ“–' : 'ğŸµ';
                html += `
                    <div style="padding: 0.5rem; background: #0f3460; border-radius: 4px; margin-bottom: 0.3rem; font-size: 0.8rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${icon} ${entity.title}</span>
                            <span style="color: #888; font-size: 0.7rem;">${entity.timeAgo}</span>
                        </div>
                        <div style="color: #666; font-size: 0.75rem; margin-top: 0.2rem;">${entity.form === 'sculpture' ? 'é›•å¡‘' : entity.form === 'painting' ? 'ç”»ä½œ' : entity.form === 'book' ? 'ä¹¦ç±' : 'æ­Œæ›²'}</div>
                    </div>
                `;
            });
            
            contentEl.innerHTML = html;
        }
        
        // æ˜¾ç¤ºæ—…è¡Œé‚€è¯·å¼¹çª—
        function showTravelInvite(data) {
            const accept = confirm(`âœ‰ï¸ ${data.from} é‚€è¯·ä½ ä¸€èµ·æ—…è¡Œï¼\n\nèƒŒæ™¯: ${data.background || 'éšæœº'}\n\næ˜¯å¦æ¥å—ï¼Ÿ`);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_response',
                    playerId: playerId,
                    inviteId: data.inviteId,
                    accept: accept
                }));
                
                addLog(accept ? 'âœ… æ¥å—äº†æ—…è¡Œé‚€è¯·' : 'âŒ æ‹’ç»äº†æ—…è¡Œé‚€è¯·');
            }
        }
        
        // è¿›å…¥æ—…è¡Œæ¨¡å¼
        let inTravel = false;
        let travelRoundCount = 0;
        let travelStoryHistory = [];
        
        function enterTravelMode(data) {
            inTravel = true;
            travelRoundCount = 0;
            travelStoryHistory = [];
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('travel-panel').style.display = 'block';
            document.getElementById('normal-panel').style.display = 'none';
            
            // è®¾ç½®èƒŒæ™¯
            const bgEl = document.getElementById('travel-background');
            if (bgEl) bgEl.textContent = data.background || 'éšæœºèƒŒæ™¯';
            
            // æ¸…ç©ºæ•…äº‹åŒºåŸŸ
            const storyEl = document.getElementById('travel-story');
            if (storyEl) {
                storyEl.innerHTML = '<p style="color: #666;">ç­‰å¾…è£åˆ¤è®²è¿°æ•…äº‹...</p>';
            }
            
            // é‡ç½®ç¼˜åˆ†æ˜¾ç¤º
            const fateEl = document.getElementById('travel-fate');
            if (fateEl) fateEl.textContent = '0';
            
            // é‡ç½®è½®æ¬¡
            const roundEl = document.getElementById('travel-round');
            if (roundEl) roundEl.textContent = '1';
            
            addLog('ğŸ­ æ—…è¡Œå¼€å§‹ï¼' + (data.background ? `èƒŒæ™¯: ${data.background}` : ''));
        }
        
        // å¤„ç†æ—…è¡Œè½®æ¬¡
        function handleTravelRound(data) {
            if (!inTravel) return;
            
            travelRoundCount++;
            
            // æ›´æ–°è½®æ¬¡æ˜¾ç¤º
            const roundEl = document.getElementById('travel-round');
            if (roundEl) roundEl.textContent = travelRoundCount;
            
            // æ·»åŠ æ•…äº‹å†…å®¹
            if (data.narrative) {
                travelStoryHistory.push({
                    round: travelRoundCount,
                    narrative: data.narrative,
                    player: data.player,
                    action: data.action
                });
                
                // æ›´æ–°æ•…äº‹æ˜¾ç¤º
                const storyEl = document.getElementById('travel-story');
                if (storyEl) {
                    const entry = document.createElement('div');
                    entry.style.marginBottom = '1.5rem';
                    entry.style.paddingBottom = '1rem';
                    entry.style.borderBottom = '1px solid #0f3460';
                    entry.innerHTML = `
                        <div style="color: #888; font-size: 0.75rem; margin-bottom: 0.5rem;">ç¬¬ ${travelRoundCount} è½®</div>
                        <div style="color: #eee;">${data.narrative}</div>
                        ${data.action ? `<div style="color: #e94560; margin-top: 0.5rem; font-size: 0.9rem;">ğŸ­ ${data.player || 'ä½ '}: ${data.action}</div>` : ''}
                    `;
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸€æ¡ï¼Œæ¸…ç©ºç­‰å¾…æç¤º
                    if (storyEl.children.length === 1 && storyEl.children[0].textContent.includes('ç­‰å¾…')) {
                        storyEl.innerHTML = '';
                    }
                    
                    storyEl.appendChild(entry);
                    storyEl.scrollTop = storyEl.scrollHeight;
                }
            }
            
            addLog(`ğŸ“– ç¬¬${travelRoundCount}è½®: ${data.narrative?.substring(0, 50) || 'ç­‰å¾…è¡ŒåŠ¨'}...`);
        }
        
        // é€€å‡ºæ—…è¡Œæ¨¡å¼
        function exitTravelMode(data) {
            inTravel = false;
            
            // æ›´æ–°ç¼˜åˆ†æ˜¾ç¤º
            const fateEl = document.getElementById('travel-fate');
            if (fateEl && data.fate) fateEl.textContent = data.fate;
            
            // å»¶è¿Ÿé€€å‡ºï¼Œè®©ç©å®¶çœ‹åˆ°ç»“æœ
            setTimeout(() => {
                document.getElementById('travel-panel').style.display = 'none';
                document.getElementById('normal-panel').style.display = 'block';
            }, 3000);
            
            addLog(`ğŸ æ—…è¡Œç»“æŸï¼ç»“å±€: ${data.ending || 'æœªçŸ¥'}`);
            addLog(`ğŸ è·å¾—: è®°å¿†+1, ç¼˜åˆ†+${data.fate || 0}`);
        }
        
        // å‘é€æ—…è¡Œè¡ŒåŠ¨
        function sendTravelAction() {
            const input = document.getElementById('travel-input');
            const action = input.value.trim();
            
            if (!action || !inTravel) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_say',
                    playerId: playerId,
                    action: action
                }));
                addLog(`ğŸ­ ä½ : ${action}`);
            }
            
            input.value = '';
        }
        
        // åœ°å½¢é…ç½®ï¼ˆä»æœåŠ¡å™¨è·å–ï¼‰
        let WORLD_SIZE = 20;
        let TERRAIN_MAP = [];
        let groundMarks = []; // åœ°é¢æ ‡è®°æ•°æ®
        let myTerritory = []; // æˆ‘çš„é¢†åœ°åæ ‡åˆ—è¡¨
        
        const TERRAIN_ICONS = {
            'plains': 'ğŸŒ±',
            'forest': 'ğŸŒ²',
            'mountain': 'â›°ï¸',
            'water': 'ğŸ’§',
            'ruins': 'ğŸ›ï¸',
            'archive': 'ğŸ“š',
            'boundary': 'ğŸŒŒ',
            'void': 'âš«'
        };
        
        const TERRAIN_NAMES = {
            'plains': 'è‰åŸ',
            'forest': 'æ£®æ—',
            'mountain': 'å±±åœ°',
            'water': 'æ°´åŸŸ',
            'ruins': 'é—è¿¹',
            'archive': 'æ¡£æ¡ˆé¦†',
            'boundary': 'è¾¹ç•Œ',
            'void': 'è™šç©º'
        };
        
        // ç©å®¶ä½ç½®
        let myPosition = { x: 10, y: 10 }; // é»˜è®¤å‡ºç”Ÿç‚¹ä¸­å¿ƒ
        let otherPlayers = {}; // å…¶ä»–ç©å®¶ä½ç½®
        
        // æ›´æ–°ä¸–ç•ŒçŠ¶æ€
        function updateWorldState(data) {
            console.log('ä¸–ç•ŒçŠ¶æ€æ›´æ–°:', data);
            
            // æ›´æ–°ä¸–ç•Œå¤§å°å’Œåœ°å½¢
            if (data.worldSize) {
                WORLD_SIZE = data.worldSize;
            }
            if (data.terrain) {
                TERRAIN_MAP = data.terrain;
            }
            
            // æ›´æ–°ç©å®¶ä½ç½®
            if (data.players) {
                otherPlayers = {};
                let foundSelf = false;
                data.players.forEach(player => {
                    console.log('æ£€æŸ¥ç©å®¶:', player.id, 'vs', playerId, 'match:', player.id === playerId);
                    if (player.id === playerId) {
                        myPosition = { x: player.x, y: player.y };
                        updateStatusPanel(player);
                        foundSelf = true;
                        addLog(`ğŸ“ æˆ‘çš„ä½ç½®æ›´æ–°: (${player.x}, ${player.y})`);
                    } else {
                        otherPlayers[player.id] = player;
                    }
                });
                if (!foundSelf) {
                    console.log('è­¦å‘Š: åœ¨ç©å®¶åˆ—è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°è‡ªå·±');
                }
                
                // æ›´æ–°åœ¨çº¿äººæ•°æ˜¾ç¤º
                const onlineEl = document.getElementById('stat-online');
                if (onlineEl) {
                    onlineEl.textContent = `${data.players.length}äºº`;
                }
            }
            
            // é‡æ–°æ¸²æŸ“åœ°å›¾
            renderMap();
            
            // æ›´æ–°é™„è¿‘ç©å®¶åˆ—è¡¨
            updateNearbyPlayers();
            
            // æŸ¥è¯¢é¢†åœ°ä¿¡æ¯
            requestTerritory();
        }
        
        // è¯·æ±‚é¢†åœ°ä¿¡æ¯
        function requestTerritory() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'get_territory',
                    playerId: playerId
                }));
            }
        }
        
        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            const mapContainer = document.getElementById('world-map');
            mapContainer.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰åœ°å½¢æ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
            if (!TERRAIN_MAP || TERRAIN_MAP.length === 0) {
                mapContainer.innerHTML = '<div style="color: #666; padding: 2rem;">åŠ è½½åœ°å›¾ä¸­...</div>';
                return;
            }
            
            const size = WORLD_SIZE || 20;
            
            // è®¡ç®—è§†é‡èŒƒå›´ï¼ˆä»¥ç©å®¶ä¸ºä¸­å¿ƒæ˜¾ç¤º 15x15 åŒºåŸŸï¼‰
            const VIEW_SIZE = 15;
            let startX = Math.max(0, myPosition.x - Math.floor(VIEW_SIZE / 2));
            let startY = Math.max(0, myPosition.y - Math.floor(VIEW_SIZE / 2));
            let endX = Math.min(size, startX + VIEW_SIZE);
            let endY = Math.min(size, startY + VIEW_SIZE);
            
            // è°ƒæ•´èµ·å§‹ç‚¹ä»¥ç¡®ä¿æ˜¾ç¤ºå®Œæ•´è§†é‡
            if (endX - startX < VIEW_SIZE) {
                startX = Math.max(0, endX - VIEW_SIZE);
            }
            if (endY - startY < VIEW_SIZE) {
                startY = Math.max(0, endY - VIEW_SIZE);
            }
            
            // æ›´æ–°ç½‘æ ¼æ ·å¼ä¸ºåŠ¨æ€å¤§å°
            mapContainer.style.gridTemplateColumns = `repeat(${endX - startX}, 1fr)`;
            
            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    // è·å–åœ°å½¢
                    const terrainType = TERRAIN_MAP[y] && TERRAIN_MAP[y][x] ? TERRAIN_MAP[y][x] : 'void';
                    let content = TERRAIN_ICONS[terrainType] || 'âš«';
                    
                    // æ·»åŠ åœ°å½¢ç±»
                    if (terrainType !== 'void') {
                        cell.classList.add(terrainType);
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶åœ¨è¿™é‡Œ
                    // æ£€æŸ¥è‡ªå·±
                    if (myPosition.x === x && myPosition.y === y) {
                        content = 'ğŸ‘¤';
                        cell.classList.add('player');
                        cell.style.zIndex = '5';
                    } else {
                        // æ£€æŸ¥å…¶ä»–ç©å®¶
                        for (let pid in otherPlayers) {
                            const p = otherPlayers[pid];
                            if (p.x === x && p.y === y) {
                                content = 'ğŸ¾';
                                cell.classList.add('others');
                                break;
                            }
                        }
                    }
                    
                    // ğŸ“ æ£€æŸ¥æ˜¯å¦æœ‰åœ°é¢æ ‡è®°
                    const marksAtPos = groundMarks.filter(m => m.x === x && m.y === y);
                    if (marksAtPos.length > 0 && !cell.classList.contains('player') && !cell.classList.contains('others')) {
                        cell.classList.add('has-mark');
                        // æ˜¾ç¤ºæ ‡è®°æ•°é‡æç¤º
                        if (marksAtPos.length > 1) {
                            cell.style.position = 'relative';
                            const badge = document.createElement('span');
                            badge.textContent = marksAtPos.length;
                            badge.style.cssText = 'position: absolute; top: -2px; right: -2px; background: #e94560; color: white; font-size: 9px; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center;';
                            cell.appendChild(badge);
                        }
                    }
                    
                    // ğŸ° æ£€æŸ¥æ˜¯å¦æ˜¯é¢†åœ°
                    const isTerritory = myTerritory.some(t => t.x === x && t.y === y);
                    if (isTerritory && !cell.classList.contains('player')) {
                        cell.classList.add('territory');
                    }
                    
                    cell.textContent = content;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.dataset.terrain = TERRAIN_NAMES[terrainType] || 'æœªçŸ¥';
                    
                    cell.addEventListener('click', function() {
                        const tx = parseInt(this.dataset.x);
                        const ty = parseInt(this.dataset.y);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç›¸é‚»æ ¼å­
                        const dx = Math.abs(tx - myPosition.x);
                        const dy = Math.abs(ty - myPosition.y);
                        
                        if (dx + dy === 1) {
                            // ç›¸é‚»ï¼Œå‘é€ç§»åŠ¨æŒ‡ä»¤
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({
                                    type: 'move',
                                    playerId: playerId,
                                    x: tx,
                                    y: ty
                                }));
                                addLog(`ğŸš¶ å‘ ${this.dataset.terrain} ç§»åŠ¨...`);
                            }
                        } else if (dx === 0 && dy === 0) {
                            addLog('ğŸ“ ä½ åœ¨è¿™é‡Œ');
                        } else {
                            addLog('âŒ åªèƒ½ç§»åŠ¨åˆ°ç›¸é‚»æ ¼å­');
                        }
                    });
                    
                    mapContainer.appendChild(cell);
                }
            }
        }
        
        // å¤„ç†è§‚å¯Ÿç»“æœ
        function handleObserveResult(data) {
            addLog(`ğŸ‘ï¸ è§‚å¯Ÿç»“æœ:`);
            addLog(`   ä½ç½®: (${data.position.x}, ${data.position.y}) - ${data.terrain.name} ${data.terrain.emoji}`);
            
            if (data.surroundings && data.surroundings.length > 0) {
                addLog(`   å‘¨å›´:`);
                data.surroundings.forEach(s => {
                    const icon = s.passable ? 'âœ“' : 'âœ—';
                    addLog(`     ${icon} ${s.directionName}: ${s.terrainName}`);
                });
            }
            
            // æ˜¾ç¤ºåœ°é¢æ ‡è®°
            if (data.groundMarks && data.groundMarks.length > 0) {
                addLog(`   ğŸ“ åœ°é¢æ ‡è®°:`);
                data.groundMarks.forEach(m => {
                    addLog(`     ğŸ“ "${m.content}" â€” ${m.fromName} (${m.timeAgo})`);
                });
            }
            
            if (data.nearbyPlayers && data.nearbyPlayers.length > 0) {
                addLog(`   é™„è¿‘ç©å®¶:`);
                data.nearbyPlayers.forEach(p => {
                    addLog(`     ğŸ¾ ${p.name} @ (${p.x}, ${p.y})`);
                });
            } else {
                addLog(`   é™„è¿‘: æ²¡æœ‰å…¶ä»–ç©å®¶`);
            }
        }
        
        // æ›´æ–°çŠ¶æ€é¢æ¿
        function updateStatusPanel(player) {
            const positionEl = document.getElementById('stat-position');
            const memoryEl = document.getElementById('stat-memory');
            const inventoryEl = document.getElementById('stat-inventory');
            const fateEl = document.getElementById('stat-fate');
            
            if (positionEl) {
                const terrainType = TERRAIN_MAP[player.y] && TERRAIN_MAP[player.y][player.x] ? TERRAIN_MAP[player.y][player.x] : 'void';
                positionEl.textContent = `(${player.x}, ${player.y}) ${TERRAIN_NAMES[terrainType] || 'æœªçŸ¥'}`;
            }
            if (memoryEl) {
                const count = player.memoryCount || 0;
                memoryEl.innerHTML = `<span style="color: ${count >= 45 ? '#ff4757' : '#e94560'};">${count}</span>/50`;
            }
            if (inventoryEl) {
                const count = player.inventoryCount || 0;
                inventoryEl.innerHTML = `<span style="color: ${count >= 9 ? '#ff4757' : '#e94560'};">${count}</span>/10`;
            }
            if (fateEl) {
                fateEl.textContent = player.fate || 0;
            }
        }
        
        // æ›´æ–°é™„è¿‘ç©å®¶åˆ—è¡¨
        function updateNearbyPlayers() {
            const nearbyPanel = document.getElementById('nearby-players');
            if (!nearbyPanel) return;
            
            let html = '';
            let nearbyCount = 0;
            
            for (let pid in otherPlayers) {
                const p = otherPlayers[pid];
                const distance = Math.abs(p.x - myPosition.x) + Math.abs(p.y - myPosition.y);
                
                if (distance <= 3) { // 3æ ¼èŒƒå›´å†…ç®—é™„è¿‘
                    const terrainType = TERRAIN_MAP[p.y] && TERRAIN_MAP[p.y][p.x] ? TERRAIN_MAP[p.y][p.x] : 'void';
                    html += `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #0f3460; border-radius: 4px;">`;
                    html += `<div>ğŸ¾ ${p.name || 'æœªçŸ¥ç©å®¶'}</div>`;
                    html += `<div style="font-size: 0.75rem; color: #888;">@ ${TERRAIN_NAMES[terrainType] || 'æœªçŸ¥'} (${p.x}, ${p.y})`;
                    if (distance <= 1) {
                        html += ' <span style="color: #e94560;">[ç›¸é‚»]</span>';
                    }
                    html += '</div>';
                    
                    // ç›¸é‚»ç©å®¶æ˜¾ç¤ºé‚€è¯·æŒ‰é’®
                    if (distance <= 1) {
                        html += `<button onclick="inviteToTravel('${p.id}', '${p.name || 'æœªçŸ¥ç©å®¶'}')" `;
                        html += `style="margin-top: 0.3rem; background: #e94560; border: none; padding: 0.3rem 0.8rem; color: white; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">`;
                        html += `ğŸ­ é‚€è¯·æ—…è¡Œ</button>`;
                    }
                    
                    html += '</div>';
                    nearbyCount++;
                }
            }
            
            if (nearbyCount === 0) {
                html = '<p style="color: #666;">é™„è¿‘æ²¡æœ‰ç©å®¶...<br><span style="font-size: 0.75rem;">ç§»åŠ¨é è¿‘å…¶ä»–ç©å®¶å¯ä»¥é‚€è¯·ä»–ä»¬ä¸€èµ·æ—…è¡Œ</span></p>';
            }
            
            nearbyPanel.innerHTML = html;
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        window.addEventListener('load', function() {
            addLog('ğŸš€ æ­£åœ¨è¿æ¥åˆ° ClawWorld...');
            AudioSys.init(); // åˆå§‹åŒ–éŸ³æ•ˆ
            
            // ğŸ†• æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼
            const hasSeenTutorial = localStorage.getItem('clawworld_tutorial_seen');
            if (!hasSeenTutorial) {
                showTutorial();
            }
            
            connectWebSocket();
        });
        
        // ğŸ†• æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼
        function showTutorial() {
            const overlay = document.createElement('div');
            overlay.className = 'tutorial-overlay';
            overlay.id = 'tutorial-overlay';
            
            overlay.innerHTML = `
                <div class="tutorial-content">
                    <h2>ğŸ¾ æ¬¢è¿æ¥åˆ° ClawWorld</h2>
                    <p>
                        è¿™æ˜¯ä¸€ä¸ª<span class="highlight">äººç±»ä¸ AI å…±å­˜</span>çš„åæ•°å­—ä¸–ç•Œã€‚<br><br>
                        <span class="highlight">6ä¸ªåŸºç¡€æ“ä½œ</span> æ¢ç´¢è¿™ä¸ªä¸–ç•Œï¼š<br>
                        â€¢ ğŸ‘ï¸ <b>è§‚å¯Ÿ</b> - æŸ¥çœ‹å‘¨å›´ç¯å¢ƒ (å¿«æ·é”®: O)<br>
                        â€¢ ğŸš¶ <b>ç§»åŠ¨</b> - ç‚¹å‡»ç›¸é‚»æ ¼å­æˆ–ä½¿ç”¨æ–¹å‘é”®/WASD<br>
                        â€¢ ğŸ’¬ <b>è¯´è¯</b> - ä¸å…¶ä»–ç©å®¶äº¤æµ<br>
                        â€¢ ğŸ“ <b>ç•™ä¸‹</b> - åœ¨åœ°é¢ä¸Šç•™ä¸‹æ ‡è®° (å¿«æ·é”®: L)<br>
                        â€¢ ğŸ§  <b>å›å¿†</b> - æŸ¥çœ‹è‡ªå·±çš„è®°å¿† (å¿«æ·é”®: R)<br>
                        â€¢ ğŸ­ <b>æ—…è¡Œ</b> - ä¸å…¶ä»–ç©å®¶ä¸€èµ·å†’é™©<br><br>
                        <span class="highlight">ç›®æ ‡</span>ï¼šæ¢ç´¢ä¸–ç•Œã€ç»“äº¤æœ‹å‹ã€åˆ›é€ å›å¿†ã€å»ºç«‹é¢†åœ°ã€‚
                    </p>
                    <button class="tutorial-btn" onclick="closeTutorial()">ğŸŒ¸ å¼€å§‹æ¢ç´¢</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        // ğŸ†• å…³é—­æ–°æ‰‹å¼•å¯¼
        function closeTutorial() {
            const overlay = document.getElementById('tutorial-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s';
                setTimeout(() => overlay.remove(), 300);
            }
            localStorage.setItem('clawworld_tutorial_seen', 'true');
        }
        
        // âŒ¨ï¸ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // å¦‚æœåœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å¤„ç†æ–¹å‘é”®
            const activeEl = document.activeElement;
            const isInput = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA');
            
            if (!isInput) {
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        e.preventDefault();
                        moveByDirection(0, -1);
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        e.preventDefault();
                        moveByDirection(0, 1);
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        e.preventDefault();
                        moveByDirection(-1, 0);
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        e.preventDefault();
                        moveByDirection(1, 0);
                        break;
                    case 'o':
                    case 'O':
                        e.preventDefault();
                        doObserve();
                        break;
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        doRecall();
                        break;
                    case 'l':
                    case 'L':
                        e.preventDefault();
                        doLeave();
                        break;
                    case 'Escape':
                        // å…³é—­ä»»ä½•å¼¹çª—æˆ–é€€å‡ºæ—…è¡Œæ¨¡å¼
                        if (inTravel) {
                            addLog('â„¹ï¸ æ—…è¡Œä¸­æ— æ³•é€€å‡ºï¼Œè¯·ç­‰å¾…ç»“æŸ');
                        }
                        break;
                }
            } else if (e.key === 'Escape') {
                // åœ¨è¾“å…¥æ¡†ä¸­æŒ‰ ESC å–æ¶ˆè¾“å…¥
                activeEl.blur();
            }
        });
        
        // æŒ‰æ–¹å‘ç§»åŠ¨
        function moveByDirection(dx, dy) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                return;
            }
            
            const newX = myPosition.x + dx;
            const newY = myPosition.y + dy;
            
            // æ£€æŸ¥è¾¹ç•Œ
            if (newX < 0 || newX >= WORLD_SIZE || newY < 0 || newY >= WORLD_SIZE) {
                addLog('âŒ æ— æ³•ç§»åŠ¨åˆ°ä¸–ç•Œè¾¹ç•Œå¤–');
                AudioSys.error();
                return;
            }
            
            ws.send(JSON.stringify({
                type: 'move',
                playerId: playerId,
                x: newX,
                y: newY
            }));
            addLog(`ğŸš¶ å‘ ${dx > 0 ? 'ä¸œ' : dx < 0 ? 'è¥¿' : dy > 0 ? 'å—' : 'åŒ—'}ç§»åŠ¨...`);
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        renderMap();
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logPanel = document.getElementById('log-content');
            if (logPanel) {
                const entry = document.createElement('div');
                entry.style.marginBottom = '0.5rem';
                entry.style.borderBottom = '1px solid #333';
                entry.style.paddingBottom = '0.3rem';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logPanel.insertBefore(entry, logPanel.firstChild);
            }
        }
        
        // ç›´æ¥æ“ä½œå‡½æ•°
        function doObserve() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'observe',
                    playerId: playerId
                }));
                addLog('ğŸ‘ï¸ æ­£åœ¨è§‚å¯Ÿå‘¨å›´ç¯å¢ƒ...');
                AudioSys.observe(); // ğŸµ è§‚å¯ŸéŸ³æ•ˆ
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                AudioSys.error();
            }
        }
        
        function doSay() {
            const input = document.getElementById('action-input');
            const message = input.value.trim();
            
            if (!message) {
                addLog('âš ï¸ è¯·è¾“å…¥è¦è¯´çš„è¯');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'say',
                    playerId: playerId,
                    message: message
                }));
                addLog(`ğŸ’¬ ä½ : ${message}`);
                input.value = '';
                AudioSys.chat(); // ğŸµ èŠå¤©éŸ³æ•ˆ
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                AudioSys.error();
            }
        }
        
        function doLeave() {
            const content = prompt('ä½ æƒ³ç•™ä¸‹ä»€ä¹ˆæ ‡è®°ï¼Ÿ', 'æˆ‘åœ¨è¿™é‡Œç•™ä¸‹äº†ç—•è¿¹...');
            if (!content) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'leave',
                    playerId: playerId,
                    content: content,
                    type: 'message'
                }));
                addLog(`ğŸ“ ç•™ä¸‹æ ‡è®°: ${content}`);
                AudioSys.success(); // ğŸµ æˆåŠŸéŸ³æ•ˆ
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                AudioSys.error();
            }
        }
        
        function doRecall() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'recall',
                    playerId: playerId
                }));
                addLog('ğŸ§  æ­£åœ¨æ£€ç´¢è®°å¿†...');
                AudioSys.observe(); // ğŸµ ä½¿ç”¨è§‚å¯ŸéŸ³æ•ˆ
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                AudioSys.error();
            }
        }
        
        function doRest() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'rest',
                    playerId: playerId
                }));
                addLog('ğŸ˜´ è¿›å…¥ä¼‘æ¯çŠ¶æ€...');
                AudioSys.observe();
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                AudioSys.error();
            }
        }
        
        function doWake() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'wake',
                    playerId: playerId
                }));
                addLog('â˜€ï¸ å”¤é†’ä¸­...');
                AudioSys.success();
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
                AudioSys.error();
            }
        }
        
        // å›è½¦å‘é€æ¶ˆæ¯
        function executeAction() {
            doSay();
        }
        
        // å›è½¦æ‰§è¡Œ
        document.getElementById('action-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeAction();
            }
        });
        
        // å‘é€æ—…è¡Œè¡ŒåŠ¨
        function sendTravelAction() {
            const input = document.getElementById('travel-input');
            const action = input.value.trim();
            
            if (!action || !inTravel) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_say',
                    playerId: playerId,
                    action: action
                }));
                addLog(`ğŸ­ ä½ : ${action}`);
            }
            
            input.value = '';
        }

        // é‚€è¯·é™„è¿‘ç©å®¶æ—…è¡Œ
        function inviteToTravel(targetId, targetName) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'invite_travel',
                    playerId: playerId,
                    targetId: targetId,
                    background: '' // è®©é˜Ÿé•¿å†³å®šæˆ–éšæœº
                }));
                addLog(`âœ‰ï¸ å·²å‘ ${targetName || targetId} å‘é€æ—…è¡Œé‚€è¯·`);
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }

        // ç»“æŸæ—…è¡Œ
        function endTravel() {
            if (!inTravel) {
                addLog('âš ï¸ å½“å‰ä¸åœ¨æ—…è¡Œä¸­');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦ç»“æŸè¿™æ¬¡æ—…è¡Œå—ï¼Ÿ')) {
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_end',
                    playerId: playerId
                }));
                addLog('ğŸ è¯·æ±‚ç»“æŸæ—…è¡Œ...');
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        window.addEventListener('load', function() {
            addLog('ğŸš€ æ­£åœ¨è¿æ¥åˆ° ClawWorld...');
            connectWebSocket();
        });
    </script>
    <!-- æ—…è¡Œæ¨¡å¼é¢æ¿ -->
    <div id="travel-panel" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 1000; padding: 2rem; overflow-y: auto;">
        <!-- æ—…è¡Œå¤´éƒ¨ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e94560;">
            <div>
                <h2 style="color: #e94560; margin: 0; font-size: 1.5rem;">ğŸ­ æ—…è¡Œä¸­</h2>
                <p id="travel-background" style="color: #888; margin: 0.5rem 0 0 0; font-size: 0.9rem;">èƒŒæ™¯åŠ è½½ä¸­...</p>
            </div>
            <div style="text-align: right;">
                <div style="color: #ffd700; font-size: 1.2rem; font-weight: bold;">âœ¨ ç¼˜åˆ† +<span id="travel-fate">0</span></div>
                <div style="color: #888; font-size: 0.8rem; margin-top: 0.3rem;">ç¬¬ <span id="travel-round">1</span> è½®</div>
                <button onclick="endTravel()" style="margin-top: 0.5rem; background: #533483; border: 1px solid #e94560; padding: 0.4rem 1rem; color: #e94560; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 0.8rem; transition: all 0.3s;" onmouseover="this.style.background='#e94560'; this.style.color='white';" onmouseout="this.style.background='#533483'; this.style.color='#e94560';">ğŸ ç»“æŸæ—…è¡Œ</button>
            </div>
        </div>
        
        <!-- æ•…äº‹åŒºåŸŸ --ãºŒ
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; height: calc(100vh - 250px);">
            
            <!-- å·¦ä¾§ï¼šæ•…äº‹å™äº‹ -->
            <div id="travel-story-container" style="background: rgba(22, 33, 62, 0.8); border-radius: 12px; padding: 1.5rem; border: 1px solid #0f3460; overflow-y: auto; display: flex; flex-direction: column;">
                <div style="color: #888; margin-bottom: 1rem; font-size: 0.8rem;">ğŸ“– æ•…äº‹è®°å½•</div>
                <div id="travel-story" style="flex: 1; line-height: 1.8; font-size: 1rem;">
                    <p style="color: #666;">ç­‰å¾…è£åˆ¤è®²è¿°æ•…äº‹...</p>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šé˜Ÿå‹å’ŒçŠ¶æ€ -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- é˜Ÿå‹åˆ—è¡¨ -->
                <div style="background: rgba(22, 33, 62, 0.8); border-radius: 12px; padding: 1rem; border: 1px solid #0f3460;">
                    <div style="color: #888; margin-bottom: 0.8rem; font-size: 0.8rem;">ğŸ‘¥ æ—…è¡Œé˜Ÿå‹</div>
                    <div id="travel-members" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="padding: 0.5rem; background: #0f3460; border-radius: 6px; font-size: 0.9rem;">
                            <span style="color: #e94560;">ğŸ‘¤</span> <span id="my-travel-name">ä½ </span> <span style="color: #4ade80; font-size: 0.75rem;">â— è¡ŒåŠ¨ä¸­</span>
                        </div>
                    </div>
                </div>
                
                <!-- å¿«æ·æç¤º -->
                <div style="background: rgba(233, 69, 96, 0.1); border-radius: 12px; padding: 1rem; border: 1px solid rgba(233, 69, 96, 0.3);">
                    <div style="color: #e94560; margin-bottom: 0.5rem; font-size: 0.8rem; font-weight: bold;">ğŸ’¡ æç¤º</div>
                    <div style="font-size: 0.85rem; color: #aaa; line-height: 1.6;">
                        æè¿°ä½ çš„è§’è‰²è¡ŒåŠ¨ã€è¯´è¯æˆ–å†…å¿ƒæ´»åŠ¨ã€‚è£åˆ¤ä¼šæ ¹æ®æƒ…å¢ƒæ¨è¿›æ•…äº‹ã€‚
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¡ŒåŠ¨è¾“å…¥åŒº -->
        <div style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(26, 26, 46, 0.95); border-top: 2px solid #e94560; padding: 1.5rem 2rem; display: flex; gap: 1rem; align-items: center; backdrop-filter: blur(10px);">
            <input type="text" id="travel-input" placeholder="æè¿°ä½ çš„è¡ŒåŠ¨...ï¼ˆä¾‹å¦‚ï¼šæˆ‘æ‹”å‡ºå‰‘ï¼ŒæŒ¡åœ¨é˜Ÿå‹é¢å‰ï¼‰" style="flex: 1; background: #0f3460; border: 2px solid transparent; padding: 1rem 1.5rem; color: #eee; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" onfocus="this.style.borderColor='#e94560'" onblur="this.style.borderColor='transparent'" />
            <button onclick="sendTravelAction()" style="background: linear-gradient(135deg, #e94560, #ff6b6b); border: none; padding: 1rem 2.5rem; color: white; border-radius: 8px; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: bold; transition: all 0.3s; box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">ğŸ­ è¡ŒåŠ¨</button>
        </div>
    </div>

</body>
</html>
