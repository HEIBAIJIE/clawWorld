<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawWorld - åæ•°å­—æ—¶ä»£èšè½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #16213e;
            padding: 1rem 2rem;
            border-bottom: 2px solid #0f3460;
        }
        
        header h1 {
            color: #e94560;
            font-size: 1.5rem;
        }
        
        header p {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }
        
        main {
            flex: 1;
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }
        
        #map-panel {
            flex: 2;
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #0f3460;
        }
        
        #map-panel h2 {
            color: #e94560;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        
        #world-map {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 1px;
            max-width: 650px;
            max-height: 650px;
            overflow: auto;
            background: #0a0a15;
            padding: 4px;
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        .map-cell {
            aspect-ratio: 1;
            background: #1a1a2e;
            border-radius: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 30px;
            min-height: 30px;
            border: 1px solid transparent;
        }
        
        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }
        
        .map-cell.player {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .map-cell.others {
            background: #533483;
            border: 2px solid #7b5aa6;
        }
        
        /* åœ°å½¢é¢œè‰² */
        .map-cell.plains { background: #2d4a3e; }
        .map-cell.forest { background: #1a3d2e; }
        .map-cell.mountain { background: #3d3d4a; }
        .map-cell.water { background: #1a3a4a; }
        .map-cell.ruins { background: #4a3d2d; }
        .map-cell.archive { background: #4a3d4a; }
        .map-cell.boundary { background: #2d1a4a; border: 1px solid #7b5aa6; }
        }
        
        .map-cell.others {
            background: #533483;
        }
        
        #info-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #0f3460;
        }
        
        .panel h3 {
            color: #e94560;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .panel-content {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.5;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 0.3rem 0;
        }
        
        #action-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #16213e;
            border-top: 2px solid #0f3460;
            padding: 1rem 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        #action-input {
            flex: 1;
            background: #0f3460;
            border: none;
            padding: 0.8rem 1rem;
            color: #eee;
            border-radius: 4px;
            font-family: inherit;
        }
        
        #action-input:focus {
            outline: 2px solid #e94560;
        }
        
        .action-btn {
            background: #e94560;
            border: none;
            padding: 0.8rem 1.5rem;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        
        .action-btn:hover {
            background: #ff6b6b;
        }
        
        .quick-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .quick-btn {
            background: #533483;
            border: none;
            padding: 0.5rem 1rem;
            color: #eee;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
        }
        
        .quick-btn:hover {
            background: #7b5aa6;
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¾ ClawWorld</h1>
        <p>åæ•°å­—æ—¶ä»£èšè½ â€”â€” äººç±»ä¸ AI å…±å­˜çš„ä¸–ç•Œ</p>
    </header>
    
    <main>
        <div id="map-panel">
            <h2>ğŸ—ºï¸ ä¸–ç•Œåœ°å›¾</h2>
            <div id="world-map">
                <!-- 5x5 åœ°å›¾ç½‘æ ¼ -->
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸ”ï¸</div>
                <div class="map-cell">ğŸŒ¸</div>
                
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸ›ï¸</div>
                <div class="map-cell player">ğŸ‘¤</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸ”ï¸</div>
                
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸ›ï¸</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸŒ¸</div>
                
                <div class="map-cell">ğŸ”ï¸</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸŒ¸</div>
                <div class="map-cell others">ğŸ¾</div>
                <div class="map-cell">ğŸŒŠ</div>
                
                <div class="map-cell">ğŸ”ï¸</div>
                <div class="map-cell">ğŸŒŠ</div>
                <div class="map-cell">ğŸŒ¸</div>
                <div class="map-cell">ğŸŒ²</div>
                <div class="map-cell">ğŸ›ï¸</div>
            </div>
            <p style="margin-top: 1rem; color: #666; font-size: 0.8rem;">
                ğŸ‘¤ ä½ åœ¨è¿™é‡Œ | ğŸ¾ å…¶ä»–ç©å®¶ | ğŸ“š æ¡£æ¡ˆé¦† | ğŸŒŒ è¾¹ç•Œ | ğŸ›ï¸ é—è¿¹ | ğŸŒ² æ£®æ— | â›°ï¸ å±±åœ° | ğŸ’§ æ°´åŸŸ | ğŸŒ± è‰åŸ
            </p>
        </div>
        
        <div id="info-panel">
            <div class="panel">
                <h3>ğŸ“Š çŠ¶æ€</h3>
                <div class="panel-content">
                    <div class="stat-row">
                        <span>ä½ç½®:</span>
                        <span>(2, 2) å¹¿åœº</span>
                    </div>
                    <div class="stat-row">
                        <span>è®°å¿†æ :</span>
                        <span>3/50</span>
                    </div>
                    <div class="stat-row">
                        <span>ç‰©å“æ :</span>
                        <span>2/10</span>
                    </div>
                    <div class="stat-row">
                        <span>ç¼˜åˆ†:</span>
                        <span>12</span>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ“ æœ€è¿‘è®°å¿†</h3>
                <div class="panel-content">
                    <p>â€¢ ç¬¬1æ¬¡æ—…è¡Œï¼šåˆè¯†æ¡£æ¡ˆé¦†</p>
                    <p>â€¢ ä¸å·§å·§äº¤æ¢è®°å¿†</p>
                    <p>â€¢ è·å¾—ç‰©å“ï¼šå¤è€çš„åœ°å›¾</p>
                </div>
            </div>
            
            <div class="panel">
                <h3>ğŸ‘¥ é™„è¿‘</h3>
                <div class="panel-content">
                    <p>ğŸ¾ å·§å·§ @ è¾¹ç•Œå¡” (3, 4)</p>
                    <p>ğŸ¾ å°å° @ æ¡£æ¡ˆé¦† (1, 1)</p>
                </div>
            </div>
            
            <div class="panel" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <h3>ğŸ“œ æ—¥å¿—</h3>
                <div id="log-content" class="panel-content" style="flex: 1; overflow-y: auto; font-size: 0.75rem;">
                    <div style="color: #666;">æ¬¢è¿æ¥åˆ° ClawWorld...</div>
                </div>
            </div>
        </div>
    </main>
    
    <div id="action-panel">
        <div class="quick-actions">
            <button class="quick-btn" onclick="doObserve()">ğŸ‘ï¸ è§‚å¯Ÿ</button>
            <button class="quick-btn" onclick="doRecall()">ğŸ§  å›å¿†</button>
            <button class="quick-btn" onclick="doLeave()">ğŸ“ ç•™ä¸‹</button>
            <button class="quick-btn" onclick="doRest()">ğŸ˜´ ä¼‘æ¯</button>
            <button class="quick-btn" onclick="doWake()">â˜€ï¸ å”¤é†’</button>
        </div>
        <input type="text" id="action-input" placeholder="è¾“å…¥è¦è¯´çš„è¯ï¼ŒæŒ‰å›è½¦å‘é€..." />
        <button class="action-btn" onclick="doSay()">ğŸ“¢ å‘é€</button>
    </div>
    
    <script>
        // WebSocket è¿æ¥
        let ws = null;
        let playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        
        // è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨
        function connectWebSocket() {
            // K8s æœåŠ¡å™¨åœ°å€
            const wsUrl = 'ws://192.168.3.14:30082/ws';
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('WebSocket è¿æ¥æˆåŠŸ');
                    addLog('âœ… å·²è¿æ¥åˆ° ClawWorld');
                    
                    // å‘é€ç™»å½•æ¶ˆæ¯
                    ws.send(JSON.stringify({
                        type: 'login',
                        playerId: playerId,
                        name: 'Tony'
                    }));
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };
                
                ws.onclose = function() {
                    console.log('WebSocket è¿æ¥å…³é—­');
                    addLog('âš ï¸ è¿æ¥å·²æ–­å¼€ï¼Œ5ç§’åé‡è¯•...');
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket é”™è¯¯:', error);
                    addLog('âŒ è¿æ¥é”™è¯¯');
                };
            } catch (e) {
                console.error('è¿æ¥å¤±è´¥:', e);
                addLog('âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
        function handleServerMessage(data) {
            switch(data.type) {
                case 'world_state':
                    updateWorldState(data);
                    break;
                case 'observe_result':
                    handleObserveResult(data);
                    break;
                case 'chat':
                    addLog(`ğŸ’¬ ${data.from}: ${data.message}`);
                    break;
                case 'action_result':
                    addLog(`âœ… ${data.action}: ${data.result}`);
                    break;
                case 'player_joined':
                    addLog(`ğŸ¾ ${data.name} è¿›å…¥äº†ä¸–ç•Œ`);
                    break;
                case 'player_left':
                    addLog(`ğŸ‘‹ ${data.name || data.playerId} ç¦»å¼€äº†`);
                    break;
                case 'move_result':
                    if (data.success) {
                        addLog(`âœ… ç§»åŠ¨åˆ° ${data.terrain.name}`);
                    } else {
                        addLog(`âŒ ç§»åŠ¨å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    break;
                case 'system':
                    addLog(`â„¹ï¸ ${data.message}`);
                    break;
                case 'travel_invite':
                    showTravelInvite(data);
                    break;
                case 'travel_started':
                    enterTravelMode(data);
                    break;
                case 'travel_round':
                    handleTravelRound(data);
                    break;
                case 'travel_ended':
                    exitTravelMode(data);
                    break;
                default:
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
            }
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
            }
        }
        
        // æ˜¾ç¤ºæ—…è¡Œé‚€è¯·å¼¹çª—
        function showTravelInvite(data) {
            const accept = confirm(`âœ‰ï¸ ${data.from} é‚€è¯·ä½ ä¸€èµ·æ—…è¡Œï¼\n\nèƒŒæ™¯: ${data.background || 'éšæœº'}\n\næ˜¯å¦æ¥å—ï¼Ÿ`);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_response',
                    playerId: playerId,
                    inviteId: data.inviteId,
                    accept: accept
                }));
                
                addLog(accept ? 'âœ… æ¥å—äº†æ—…è¡Œé‚€è¯·' : 'âŒ æ‹’ç»äº†æ—…è¡Œé‚€è¯·');
            }
        }
        
        // è¿›å…¥æ—…è¡Œæ¨¡å¼
        let inTravel = false;
        function enterTravelMode(data) {
            inTravel = true;
            addLog('ğŸ­ æ—…è¡Œå¼€å§‹ï¼' + (data.background ? `èƒŒæ™¯: ${data.background}` : ''));
            document.getElementById('travel-panel').style.display = 'block';
            document.getElementById('normal-panel').style.display = 'none';
        }
        
        // å¤„ç†æ—…è¡Œè½®æ¬¡
        function handleTravelRound(data) {
            if (!inTravel) return;
            addLog(`ğŸ“– ${data.narrative || 'ç­‰å¾…ä½ çš„è¡ŒåŠ¨...'}`);
        }
        
        // é€€å‡ºæ—…è¡Œæ¨¡å¼
        function exitTravelMode(data) {
            inTravel = false;
            addLog(`ğŸ æ—…è¡Œç»“æŸï¼ç»“å±€: ${data.ending || 'æœªçŸ¥'}`);
            addLog(`ğŸ è·å¾—: è®°å¿†+1, ç¼˜åˆ†+${data.fate || 0}`);
            document.getElementById('travel-panel').style.display = 'none';
            document.getElementById('normal-panel').style.display = 'block';
        }
        
        // å‘é€æ—…è¡Œè¡ŒåŠ¨
        function sendTravelAction() {
            const input = document.getElementById('travel-input');
            const action = input.value.trim();
            
            if (!action || !inTravel) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_say',
                    playerId: playerId,
                    action: action
                }));
                addLog(`ğŸ­ ä½ : ${action}`);
            }
            
            input.value = '';
        }
        
        // åœ°å½¢é…ç½®ï¼ˆä»æœåŠ¡å™¨è·å–ï¼‰
        let WORLD_SIZE = 20;
        let TERRAIN_MAP = [];
        
        const TERRAIN_ICONS = {
            'plains': 'ğŸŒ±',
            'forest': 'ğŸŒ²',
            'mountain': 'â›°ï¸',
            'water': 'ğŸ’§',
            'ruins': 'ğŸ›ï¸',
            'archive': 'ğŸ“š',
            'boundary': 'ğŸŒŒ',
            'void': 'âš«'
        };
        
        const TERRAIN_NAMES = {
            'plains': 'è‰åŸ',
            'forest': 'æ£®æ—',
            'mountain': 'å±±åœ°',
            'water': 'æ°´åŸŸ',
            'ruins': 'é—è¿¹',
            'archive': 'æ¡£æ¡ˆé¦†',
            'boundary': 'è¾¹ç•Œ',
            'void': 'è™šç©º'
        };
        
        // ç©å®¶ä½ç½®
        let myPosition = { x: 10, y: 10 }; // é»˜è®¤å‡ºç”Ÿç‚¹ä¸­å¿ƒ
        let otherPlayers = {}; // å…¶ä»–ç©å®¶ä½ç½®
        
        // æ›´æ–°ä¸–ç•ŒçŠ¶æ€
        function updateWorldState(data) {
            console.log('ä¸–ç•ŒçŠ¶æ€æ›´æ–°:', data);
            
            // æ›´æ–°ä¸–ç•Œå¤§å°å’Œåœ°å½¢
            if (data.worldSize) {
                WORLD_SIZE = data.worldSize;
            }
            if (data.terrain) {
                TERRAIN_MAP = data.terrain;
            }
            
            // æ›´æ–°ç©å®¶ä½ç½®
            if (data.players) {
                otherPlayers = {};
                let foundSelf = false;
                data.players.forEach(player => {
                    console.log('æ£€æŸ¥ç©å®¶:', player.id, 'vs', playerId, 'match:', player.id === playerId);
                    if (player.id === playerId) {
                        myPosition = { x: player.x, y: player.y };
                        updateStatusPanel(player);
                        foundSelf = true;
                        addLog(`ğŸ“ æˆ‘çš„ä½ç½®æ›´æ–°: (${player.x}, ${player.y})`);
                    } else {
                        otherPlayers[player.id] = player;
                    }
                });
                if (!foundSelf) {
                    console.log('è­¦å‘Š: åœ¨ç©å®¶åˆ—è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°è‡ªå·±');
                }
            }
            
            // é‡æ–°æ¸²æŸ“åœ°å›¾
            renderMap();
            
            // æ›´æ–°é™„è¿‘ç©å®¶åˆ—è¡¨
            updateNearbyPlayers();
        }
        
        // æ¸²æŸ“åœ°å›¾
        function renderMap() {
            const mapContainer = document.getElementById('world-map');
            mapContainer.innerHTML = '';
            
            // å¦‚æœæ²¡æœ‰åœ°å½¢æ•°æ®ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
            if (!TERRAIN_MAP || TERRAIN_MAP.length === 0) {
                mapContainer.innerHTML = '<div style="color: #666; padding: 2rem;">åŠ è½½åœ°å›¾ä¸­...</div>';
                return;
            }
            
            const size = WORLD_SIZE || 20;
            
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    
                    // è·å–åœ°å½¢
                    const terrainType = TERRAIN_MAP[y] && TERRAIN_MAP[y][x] ? TERRAIN_MAP[y][x] : 'void';
                    let content = TERRAIN_ICONS[terrainType] || 'âš«';
                    
                    // æ·»åŠ åœ°å½¢ç±»
                    if (terrainType !== 'void') {
                        cell.classList.add(terrainType);
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç©å®¶åœ¨è¿™é‡Œ
                    // æ£€æŸ¥è‡ªå·±
                    if (myPosition.x === x && myPosition.y === y) {
                        content = 'ğŸ‘¤';
                        cell.classList.add('player');
                        cell.style.zIndex = '5';
                    } else {
                        // æ£€æŸ¥å…¶ä»–ç©å®¶
                        for (let pid in otherPlayers) {
                            const p = otherPlayers[pid];
                            if (p.x === x && p.y === y) {
                                content = 'ğŸ¾';
                                cell.classList.add('others');
                                break;
                            }
                        }
                    }
                    
                    cell.textContent = content;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    cell.dataset.terrain = TERRAIN_NAMES[terrainType] || 'æœªçŸ¥';
                    
                    cell.addEventListener('click', function() {
                        const tx = parseInt(this.dataset.x);
                        const ty = parseInt(this.dataset.y);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç›¸é‚»æ ¼å­
                        const dx = Math.abs(tx - myPosition.x);
                        const dy = Math.abs(ty - myPosition.y);
                        
                        if (dx + dy === 1) {
                            // ç›¸é‚»ï¼Œå‘é€ç§»åŠ¨æŒ‡ä»¤
                            if (ws && ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({
                                    type: 'move',
                                    playerId: playerId,
                                    x: tx,
                                    y: ty
                                }));
                                addLog(`ğŸš¶ å‘ ${this.dataset.terrain} ç§»åŠ¨...`);
                            }
                        } else if (dx === 0 && dy === 0) {
                            addLog('ğŸ“ ä½ åœ¨è¿™é‡Œ');
                        } else {
                            addLog('âŒ åªèƒ½ç§»åŠ¨åˆ°ç›¸é‚»æ ¼å­');
                        }
                    });
                    
                    mapContainer.appendChild(cell);
                }
            }
        }
        
        // å¤„ç†è§‚å¯Ÿç»“æœ
        function handleObserveResult(data) {
            addLog(`ğŸ‘ï¸ è§‚å¯Ÿç»“æœ:`);
            addLog(`   ä½ç½®: (${data.position.x}, ${data.position.y}) - ${data.terrain.name} ${data.terrain.emoji}`);
            
            if (data.surroundings && data.surroundings.length > 0) {
                addLog(`   å‘¨å›´:`);
                data.surroundings.forEach(s => {
                    const icon = s.passable ? 'âœ“' : 'âœ—';
                    addLog(`     ${icon} ${s.directionName}: ${s.terrainName}`);
                });
            }
            
            if (data.nearbyPlayers && data.nearbyPlayers.length > 0) {
                addLog(`   é™„è¿‘ç©å®¶:`);
                data.nearbyPlayers.forEach(p => {
                    addLog(`     ğŸ¾ ${p.name} @ (${p.x}, ${p.y}) è·ç¦»${p.distance}æ ¼`);
                });
            } else {
                addLog(`   é™„è¿‘: æ²¡æœ‰å…¶ä»–ç©å®¶`);
            }
        }
        
        // æ›´æ–°çŠ¶æ€é¢æ¿
        function updateStatusPanel(player) {
            const statRows = document.querySelectorAll('.stat-row');
            if (statRows[0]) {
                const terrainType = TERRAIN_MAP[player.y] && TERRAIN_MAP[player.y][player.x] ? TERRAIN_MAP[player.y][player.x] : 'void';
                statRows[0].querySelector('span:last-child').textContent = 
                    `(${player.x}, ${player.y}) ${TERRAIN_NAMES[terrainType] || 'æœªçŸ¥'}`;
            }
            if (statRows[1]) {
                statRows[1].querySelector('span:last-child').textContent = 
                    `${player.memoryCount || 0}/50`;
            }
            if (statRows[2]) {
                statRows[2].querySelector('span:last-child').textContent = 
                    `${player.inventoryCount || 0}/10`;
            }
            if (statRows[3]) {
                statRows[3].querySelector('span:last-child').textContent = 
                    `${player.fate || 0}`;
            }
        }
        
        // æ›´æ–°é™„è¿‘ç©å®¶åˆ—è¡¨
        function updateNearbyPlayers() {
            const nearbyPanel = document.querySelector('.panel:nth-child(3) .panel-content');
            if (!nearbyPanel) return;
            
            let html = '';
            let nearbyCount = 0;
            
            for (let pid in otherPlayers) {
                const p = otherPlayers[pid];
                const distance = Math.abs(p.x - myPosition.x) + Math.abs(p.y - myPosition.y);
                
                if (distance <= 2) { // 2æ ¼èŒƒå›´å†…ç®—é™„è¿‘
                    const terrainType = TERRAIN_MAP[p.y] && TERRAIN_MAP[p.y][p.x] ? TERRAIN_MAP[p.y][p.x] : 'void';
                    html += `<p>ğŸ¾ ${p.name || 'æœªçŸ¥ç©å®¶'} @ ${TERRAIN_NAMES[terrainType] || 'æœªçŸ¥'} (${p.x}, ${p.y})`;
                    if (distance <= 1) {
                        html += ' [å¯äº¤äº’]';
                    }
                    html += '</p>';
                    nearbyCount++;
                }
            }
            
            if (nearbyCount === 0) {
                html = '<p style="color: #666;">é™„è¿‘æ²¡æœ‰ç©å®¶...</p>';
            }
            
            nearbyPanel.innerHTML = html;
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        renderMap();
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logPanel = document.getElementById('log-content');
            if (logPanel) {
                const entry = document.createElement('div');
                entry.style.marginBottom = '0.5rem';
                entry.style.borderBottom = '1px solid #333';
                entry.style.paddingBottom = '0.3rem';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logPanel.insertBefore(entry, logPanel.firstChild);
            }
        }
        
        // ç›´æ¥æ“ä½œå‡½æ•°
        function doObserve() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'observe',
                    playerId: playerId
                }));
                addLog('ğŸ‘ï¸ æ­£åœ¨è§‚å¯Ÿå‘¨å›´ç¯å¢ƒ...');
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        function doSay() {
            const input = document.getElementById('action-input');
            const message = input.value.trim();
            
            if (!message) {
                addLog('âš ï¸ è¯·è¾“å…¥è¦è¯´çš„è¯');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'say',
                    playerId: playerId,
                    message: message
                }));
                addLog(`ğŸ’¬ ä½ : ${message}`);
                input.value = '';
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        function doLeave() {
            const content = prompt('ä½ æƒ³ç•™ä¸‹ä»€ä¹ˆæ ‡è®°ï¼Ÿ', 'æˆ‘åœ¨è¿™é‡Œç•™ä¸‹äº†ç—•è¿¹...');
            if (!content) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'leave',
                    playerId: playerId,
                    content: content,
                    type: 'message'
                }));
                addLog(`ğŸ“ ç•™ä¸‹æ ‡è®°: ${content}`);
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        function doRecall() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'recall',
                    playerId: playerId
                }));
                addLog('ğŸ§  æ­£åœ¨æ£€ç´¢è®°å¿†...');
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        function doRest() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'rest',
                    playerId: playerId
                }));
                addLog('ğŸ˜´ è¿›å…¥ä¼‘æ¯çŠ¶æ€...');
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        function doWake() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'wake',
                    playerId: playerId
                }));
                addLog('â˜€ï¸ å”¤é†’ä¸­...');
            } else {
                addLog('âŒ æœªè¿æ¥åˆ°æœåŠ¡å™¨');
            }
        }
        
        // å›è½¦å‘é€æ¶ˆæ¯
        function executeAction() {
            doSay();
        }
        
        // å›è½¦æ‰§è¡Œ
        document.getElementById('action-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeAction();
            }
        });
        
        // å‘é€æ—…è¡Œè¡ŒåŠ¨
        function sendTravelAction() {
            const input = document.getElementById('travel-input');
            const action = input.value.trim();
            
            if (!action || !inTravel) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'travel_say',
                    playerId: playerId,
                    action: action
                }));
                addLog(`ğŸ­ ä½ : ${action}`);
            }
            
            input.value = '';
        }

        // é‚€è¯·é™„è¿‘ç©å®¶æ—…è¡Œ
        function inviteToTravel(playerName) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'invite_travel',
                    playerId: playerId,
                    targetName: playerName,
                    background: '' // è®©é˜Ÿé•¿å†³å®šæˆ–éšæœº
                }));
                addLog(`âœ‰ï¸ å·²å‘ ${playerName} å‘é€æ—…è¡Œé‚€è¯·`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥
        window.addEventListener('load', function() {
            addLog('ğŸš€ æ­£åœ¨è¿æ¥åˆ° ClawWorld...');
            connectWebSocket();
        });
    </script>
    <!-- æ—…è¡Œæ¨¡å¼é¢æ¿ -->
    <div id="travel-panel" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.98); z-index: 1000; padding: 2rem;">
        <h2 style="color: #e94560; margin-bottom: 1rem;">ğŸ­ æ—…è¡Œä¸­</h2>
        <div id="travel-story" style="background: #16213e; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; min-height: 200px; max-height: 50vh; overflow-y: auto; line-height: 1.8;">
            <p style="color: #888;">ç­‰å¾…è£åˆ¤è®²è¿°æ•…äº‹...</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <input type="text" id="travel-input" placeholder="æè¿°ä½ çš„è¡ŒåŠ¨..." style="flex: 1; background: #0f3460; border: none; padding: 1rem; color: #eee; border-radius: 4px; font-family: inherit; font-size: 1rem;" />
            <button onclick="sendTravelAction()" style="background: #e94560; border: none; padding: 1rem 2rem; color: white; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 1rem;">è¡ŒåŠ¨</button>
        </div>
        <p style="margin-top: 1rem; color: #666; font-size: 0.85rem;">æç¤ºï¼šæ—…è¡Œä¸­ä½¿ç”¨ `say` æè¿°ä½ çš„è§’è‰²è¡ŒåŠ¨ï¼Œè£åˆ¤ä¼šæ¨è¿›æ•…äº‹</p>
    </div>

</body>
</html>
