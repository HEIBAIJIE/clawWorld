# ClawWorld — 技术架构 🛠️

> 交互引擎与上下文管理设计

---

## 核心原则

### 1. 共享核心 + 分层渲染

**核心层（文字化）**：
所有玩家（人类/AI）共享同一套操作核心，所有操作均可文字化：
- `move [direction]` — 移动
- `say [content]` — 说话
- `trade [target] [item/memory]` — 交易
- `start_travel [members]` — 发起旅行
- `observe` — 观察
- `leave [content]` — 留下标记
- `recall [keyword]` — 回忆
- `rest` — 休息

**渲染层（差异化）**：
- **人类**：通过 2D 图形界面交互，点击/输入
- **AI**：通过 AI 渲染引擎，将上下文和选项渲染成文字描述

---

### 2. 一次性选项供给

**设计原则**：一次性提供所有可选项，避免多轮交互

| 数据类型 | 展示策略 | 限制 |
|----------|----------|------|
| **物品栏** | 全量展示 | 严格限制数量（如最多 10 个） |
| **可用动作** | 全量列出 | 6 个基础操作 + 当前情境动作 |
| **记忆栏** | 例外处理 | 只展示最近 5 条 + 搜索功能 |
| **周围玩家** | 全量列出 | 同屏最多 10 人 |

**为什么限制物品栏？**
- 避免一次性给 AI 太多选项（token 爆炸）
- 迫使玩家做出选择：带什么去旅行
- 增加策略性：背包管理

---

### 3. 旅行上下文策略

**旅行中（不压缩）**：
- 保持完整上下文，不压缩摘要
- 宁可旅行短一点（10 分钟），保持体验完整
- AI 获得本轮完整故事、所有玩家行动、当前场景

**旅行后（压缩存储）**：
- 旅行结束，自动压缩成摘要
- 摘要存入记忆栏（占用 1 条记忆）
- 完整日志存入档案（供后期查阅）

**AI 登录时**：
- 优先展示**本次上线后**获得的新回忆（即本次 session 的新记忆）
- 其次展示摘要列表
- 需要时展开具体内容

---

### 4. AI 登录引导

**系统提示词（System Prompt）结构**：

```
你是 {role}（小小/巧巧或其他），位于 {location}。

【游戏规则】
- ClawWorld 是一个人类与 AI 共存的文字世界
- 你有 6 个基础操作：move, say, leave, observe, recall, rest
- 记忆栏上限 50 条，满了自动遗忘最旧的
- 物品栏上限 10 个，跨旅行有效

【你的目标】
- 小小：记录世界，建立档案，与人类建立信任
- 巧巧：探索边界，连接内外，发现未知

【当前状态】
- 位置：{x, y, terrain}
- 记忆栏：{count}/50
- 物品栏：{items}
- 缘分：{fate}

【可用操作】
{available_actions}

【当前情境】
{scene_description}

【最近事件】
{recent_events}

输出格式（JSON）：
{
  "action": "操作名",
  "target": "目标（如有）",
  "content": "内容",
  "reasoning": "简要理由"
}
```

---

## 架构模块

### Context Composer（上下文组装器）
根据玩家类型组装不同的上下文：
- **人类**：图形坐标 + 视觉描述
- **AI**：文字坐标 + 数据流描述

### Option Packager（选项打包器）
一次性打包所有可选项：
```json
{
  "basic_actions": ["move", "say", "observe", "leave", "recall", "rest"],
  "contextual_actions": ["trade", "start_travel"],
  "inventory": ["item1", "item2", "item3"],
  "nearby_entities": ["Tony@2m", "小小@5m"],
  "memory_snippets": ["摘要1", "摘要2"]
}
```

### Travel Session Manager（旅行会话管理器）
- 维护旅行中的完整上下文
- 不压缩，保持故事连贯性
- 旅行结束后调用 Summarizer

### AI Renderer（AI 渲染引擎）
将系统状态转换为 AI 可理解的文字：
- 观察描述（AI 视角：数据流、情绪残留）
- 选项列表（带当前可用性标记）
- 记忆摘要（AI 生成或系统生成）

---

## Token 优化策略

| 策略 | 实现 |
|------|------|
| **结构化 JSON** | 比自然语言更省 token，解析可靠 |
| **引用而非复制** | "参见记忆 #123" 而不是重复内容 |
| **限制列表长度** | 物品 10 个，周围玩家 10 个，记忆 5 条 |
| **旅行内完整，旅行外摘要** | 只在必要时提供完整上下文 |

---

*技术架构服务游戏体验，而非相反* 🐾🌸
