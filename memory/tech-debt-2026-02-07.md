# ClawWorld æŠ€æœ¯å€ºåŠ¡æ¸…å•

**å®¡æŸ¥æ—¥æœŸ**: 2026-02-07  
**å®¡æŸ¥è€…**: å°å°  
**çŠ¶æ€**: ğŸ” è¿›è¡Œä¸­

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

### 1. æ•°æ®åº“è¿æ¥æ— é‡è¿æœºåˆ¶
**æ–‡ä»¶**: `services/game-core/src/database.js`  
**é—®é¢˜**: ä½¿ç”¨å•ä¾‹è¿æ¥æ¨¡å¼ï¼Œä¸€æ—¦MySQLè¿æ¥æ–­å¼€ï¼Œæ•´ä¸ªæœåŠ¡å°†å´©æºƒä¸”ä¸ä¼šè‡ªåŠ¨æ¢å¤  
**å½±å“**: æœåŠ¡å¯ç”¨æ€§é£é™©  
**å»ºè®®**: ä½¿ç”¨è¿æ¥æ±  + è‡ªåŠ¨é‡è¿æœºåˆ¶

### 2. å†…å­˜å­˜å‚¨æ— æ³•æŒä¹…åŒ–
**æ–‡ä»¶**: `services/game-core/src/redis-mem.js`  
**é—®é¢˜**: ä½¿ç”¨JavaScript Mapæ¨¡æ‹ŸRedisï¼Œè¿›ç¨‹é‡å¯åæ‰€æœ‰æ•°æ®ä¸¢å¤±ï¼Œä¸”æ— æ³•æ°´å¹³æ‰©å±•  
**å½±å“**: æ•°æ®ä¸¢å¤±é£é™©ã€æ— æ³•æ‰©å®¹  
**å»ºè®®**: æ¥å…¥çœŸå®Redisæˆ–ä½¿ç”¨æ•°æ®åº“

### 3. æ—…è¡Œç³»ç»Ÿç«æ€æ¡ä»¶
**æ–‡ä»¶**: `services/game-core/src/travel.js`  
**é—®é¢˜**: ä½¿ç”¨`setImmediate`è¿›è¡Œå¼‚æ­¥Refereeè°ƒç”¨ï¼Œæ— å¹¶å‘æ§åˆ¶ï¼Œå¤šä¸ªç©å®¶åŒæ—¶è¡ŒåŠ¨å¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰  
**ä»£ç ä½ç½®**: 
```javascript
setImmediate(async () => {
  const adjudication = await adjudicateActionFromReferee(...)
  // æ— é”æœºåˆ¶ï¼Œå¯èƒ½è¦†ç›–å…¶ä»–ç©å®¶çš„è£å®š
})
```
**å½±å“**: æ•°æ®ä¸ä¸€è‡´  
**å»ºè®®**: ä½¿ç”¨é˜Ÿåˆ—æˆ–é”æœºåˆ¶åºåˆ—åŒ–å¤„ç†

### 4. WebSocketè¿æ¥å†…å­˜æ³„æ¼é£é™©
**æ–‡ä»¶**: `services/game-core/src/websocket.js`  
**é—®é¢˜**: å¦‚æœ`close`äº‹ä»¶æœªè§¦å‘ï¼ˆå¦‚å®¢æˆ·ç«¯ç›´æ¥æ–­ç”µï¼‰ï¼Œconnections Mapä¸­çš„è¿æ¥ä¸ä¼šè¢«æ¸…ç†  
**å½±å“**: å†…å­˜æ³„æ¼ã€å¹½çµç©å®¶  
**å»ºè®®**: æ·»åŠ å¿ƒè·³æ£€æµ‹ + è¶…æ—¶æ¸…ç†

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆéœ€è¦ä¿®å¤ï¼‰

### 5. é…ç½®é‡å¤å®šä¹‰
**æ–‡ä»¶**: 
- `services/game-core/src/config.js` å®šä¹‰ `GAME.WORLD_SIZE = 20`
- `services/game-core/src/world.js` å®šä¹‰ `WORLD_SIZE = 20`
**é—®é¢˜**: åŒä¸€å¸¸é‡å¤šå¤„å®šä¹‰ï¼Œç»´æŠ¤å›°éš¾  
**å»ºè®®**: ç»Ÿä¸€ä»configå¯¼å…¥

### 6. ç¡¬ç¼–ç IPåœ°å€
**æ–‡ä»¶**: `services/game-core/src/config.js`  
**ä»£ç **: 
```javascript
REFEREE_URL: process.env.REFEREE_URL || 'http://192.168.3.14:3004',
GAME_CORE_URL: process.env.GAME_CORE_URL || 'http://192.168.3.14:30082',
```
**é—®é¢˜**: è¿å12-factor appåŸåˆ™ï¼Œéƒ¨ç½²åˆ°æ–°ç¯å¢ƒéœ€æ”¹ä»£ç   
**å»ºè®®**: å®Œå…¨ä¾èµ–ç¯å¢ƒå˜é‡ï¼Œæ— é»˜è®¤å€¼IP

### 7. åœ¨çº¿çŠ¶æ€å­—ç¬¦ä¸²æ¯”è¾ƒ
**æ–‡ä»¶**: `services/game-core/src/redis-mem.js`  
**ä»£ç **: 
```javascript
if (playerData && playerData.online === 'false') {
```
**é—®é¢˜**: ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒå¸ƒå°”å€¼ï¼Œç±»å‹ä¸å®‰å…¨  
**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨å¸ƒå°”å€¼æˆ–ä¸¥æ ¼ç±»å‹æ£€æŸ¥

### 8. è½®è¯¢ä»£æ›¿äº‹ä»¶é©±åŠ¨
**æ–‡ä»¶**: `services/game-core/src/websocket.js` (handleTravelSay)  
**é—®é¢˜**: æ¯ç§’è½®è¯¢30æ¬¡æ£€æŸ¥è£å®šç»“æœï¼Œæµªè´¹èµ„æºä¸”å»¶è¿Ÿé«˜  
**ä»£ç **: 
```javascript
const pollInterval = setInterval(async () => {
  // è½®è¯¢30æ¬¡
}, 1000);
```
**å»ºè®®**: ä½¿ç”¨Pub/Subæˆ–å›è°ƒæœºåˆ¶

### 9. ä¸ä¸€è‡´çš„è®°å¿†é™åˆ¶
**æ–‡ä»¶**: 
- `redis-mem.js`: `MEMORY_LIMIT = 50` (æ–‡æ¡£ä¸€è‡´)
- `websocket.js`: `handleRecall` è¿”å› `result.slice(0, 10)`
- `index.js`: `/player/:id/memories` é»˜è®¤limit=10
**é—®é¢˜**: ä¸Tech.mdæ‰¿è¯ºçš„"è®°å¿†æ ä¸Šé™50"ä¸ç¬¦ï¼Œå®é™…åªå±•ç¤º10æ¡  
**å»ºè®®**: ç»Ÿä¸€é™åˆ¶å¹¶æ›´æ–°æ–‡æ¡£æˆ–ä»£ç 

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆæ”¹è¿›å»ºè®®ï¼‰

### 10. é­”æ³•æ•°å­—
**æ–‡ä»¶**: å¤šå¤„  
**ç¤ºä¾‹**:
- `travel.js`: 3000ms ç¡¬ç¼–ç ç­‰å¾…å¼€åœº
- `travel.js`: 5åˆ†é’Ÿé‚€è¯·è¿‡æœŸ (300ç§’)
- `redis-mem.js`: 30åˆ†é’Ÿç¦»çº¿æ¸…ç†
**å»ºè®®**: æå–åˆ°é…ç½®æ–‡ä»¶

### 11. é‡å¤ä»£ç 
**æ–‡ä»¶**: 
- `players.js` å’Œ `websocket.js` éƒ½æœ‰ç§»åŠ¨ã€è§‚å¯Ÿé€»è¾‘
- `websocket.js` å’Œ `index.js` éƒ½æœ‰formatTimeAgoå‡½æ•°
**å»ºè®®**: æå–åˆ°å…±äº«utils

### 12. åŠ¨æ€requireå½±å“æ€§èƒ½
**æ–‡ä»¶**: `services/game-core/src/index.js`  
**ä»£ç **: 
```javascript
const { getServerStats } = require('./websocket'); // å‡½æ•°å†…åŠ¨æ€require
```
**é—®é¢˜**: è¿è¡Œæ—¶åŠ¨æ€requireå¯èƒ½é˜»å¡äº‹ä»¶å¾ªç¯  
**å»ºè®®**: ç»Ÿä¸€åˆ°æ–‡ä»¶é¡¶éƒ¨require

### 13. ç¼ºå°‘è¾“å…¥éªŒè¯
**æ–‡ä»¶**: `services/referee/src/index.js`  
**é—®é¢˜**: APIç«¯ç‚¹æ²¡æœ‰éªŒè¯è¯·æ±‚ä½“ç»“æ„  
**å»ºè®®**: æ·»åŠ schemaéªŒè¯ï¼ˆå¦‚ä½¿ç”¨fastifyçš„schemaï¼‰

### 14. é”™è¯¯å¤„ç†ä¸ä¸€è‡´
**æ–‡ä»¶**: å¤šå¤„  
**é—®é¢˜**: æœ‰çš„è¿”å›`{error: string}`ï¼Œæœ‰çš„æŠ›å‡ºå¼‚å¸¸ï¼Œæœ‰çš„è¿”å›500  
**å»ºè®®**: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼

### 15. API Key ç¡¬ç¼–ç ï¼ˆå®‰å…¨é£é™©ï¼‰
**æ–‡ä»¶**: `services/referee/src/llm.js`  
**ä»£ç **: 
```javascript
const APIYI_API_KEY = process.env.APIYI_API_KEY || 'sk-uX8hVbhIM27Xt4iJE84b79900eAa4931B0122034Bb092510';
```
**é—®é¢˜**: API Keyç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œå­˜åœ¨æ³„éœ²é£é™©  
**å»ºè®®**: ç§»é™¤é»˜è®¤å€¼ï¼Œå¼ºåˆ¶ä»ç¯å¢ƒå˜é‡è¯»å–

### 16. é‡å¤å‡½æ•°å®šä¹‰
**æ–‡ä»¶**: 
- `players.js`: `getTimeAgo`
- `territory.js`: `getTimeAgo` (å®Œå…¨ç›¸åŒçš„å®ç°)
- `websocket.js`: `formatTimeAgo` (åŠŸèƒ½ç›¸åŒï¼Œå‘½åä¸åŒ)
**é—®é¢˜**: ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾  
**å»ºè®®**: æå–åˆ° `utils/helpers.js`

### 17. å…¨å±€å˜é‡æ±¡æŸ“
**æ–‡ä»¶**: `services/game-core/src/websocket.js`  
**ä»£ç **: 
```javascript
global.broadcastToAll = broadcastToAll;
```
**æ–‡ä»¶**: `services/game-core/src/world-events.js`  
**ä»£ç **: ç›´æ¥ä½¿ç”¨ `global.broadcastToAll`
**é—®é¢˜**: ä½¿ç”¨globalä¼ é€’ä¾èµ–ï¼Œéš¾ä»¥æµ‹è¯•å’Œè¿½è¸ª  
**å»ºè®®**: ä½¿ç”¨ä¾èµ–æ³¨å…¥æˆ–äº‹ä»¶æ€»çº¿æ¨¡å¼

### 18. LLMè°ƒç”¨æ— é‡è¯•æœºåˆ¶
**æ–‡ä»¶**: `services/referee/src/llm.js`  
**é—®é¢˜**: LLMè°ƒç”¨å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæ— é‡è¯•é€»è¾‘  
**å»ºè®®**: æ·»åŠ æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶

### 19. åŠ¨æ€requireæ€§èƒ½é—®é¢˜
**æ–‡ä»¶**: `services/game-core/src/routes/players.js`  
**ä»£ç **: 
```javascript
const { broadcastToNearby } = require('./websocket'); // å‡½æ•°å†…require
const { getMemories } = require('./redis-mem'); // å‡½æ•°å†…require
```
**æ–‡ä»¶**: `services/game-core/src/routes/territory.js` å¤šå¤„
**é—®é¢˜**: å‡½æ•°å†…éƒ¨åŠ¨æ€requireï¼Œæ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°è§£ææ¨¡å—  
**å»ºè®®**: ç»Ÿä¸€åˆ°æ–‡ä»¶é¡¶éƒ¨require

### 20. ä¸–ç•Œäº‹ä»¶æ— æŒä¹…åŒ–
**æ–‡ä»¶**: `services/game-core/src/world-events.js`  
**é—®é¢˜**: äº‹ä»¶æ•°æ®å­˜å‚¨åœ¨å†…å­˜å˜é‡ä¸­ï¼ŒæœåŠ¡é‡å¯åä¸¢å¤±  
**å»ºè®®**: ä½¿ç”¨Redisæˆ–æ•°æ®åº“å­˜å‚¨äº‹ä»¶çŠ¶æ€

---

## ğŸ“‹ ä¸æ–‡æ¡£ä¸ç¬¦æ¸…å•

| æ–‡æ¡£å£°æ˜ | å®é™…å®ç° | çŠ¶æ€ |
|---------|---------|------|
| è®°å¿†æ ä¸Šé™50æ¡ | redis-memé™åˆ¶50ï¼Œä½†APIåªè¿”å›10æ¡ | âŒ ä¸ç¬¦ |
| æ—…è¡Œæ—¶é•¿çº¦10åˆ†é’Ÿ | ä»£ç æ— æ—¶é•¿æ§åˆ¶é€»è¾‘ | âŒ æœªå®ç° |
| ç‰©å“æ ä¸Šé™10ä¸ª | æ­£ç¡®å®ç° | âœ… ç¬¦åˆ |
| 6ä¸ªåŸºç¡€æ“ä½œ | æ­£ç¡®å®ç°(move,observe,say,leave,recall,rest) | âœ… ç¬¦åˆ |
| æ–‡å­—æ¸²æŸ“å¼•æ“ | æœªå‘ç°è¯¥æ¨¡å—å®ç° | â“ å¾…ç¡®è®¤ |
| leaveæ“ä½œè¯­ä¹‰ | WebSocket:ç•™ä¸‹æ ‡è®° / HTTP API:ä¸‹çº¿ | âŒ å†²çª |

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

**ç¬¬ä¸€é˜¶æ®µï¼ˆæœ¬å‘¨ï¼‰**: 
- #15 API Keyç¡¬ç¼–ç ï¼ˆå®‰å…¨é£é™©æœ€é«˜ï¼‰
- #1 æ•°æ®åº“è¿æ¥æ± 
- #3 æ—…è¡Œç³»ç»Ÿç«æ€æ¡ä»¶  
- #4 WebSocketå¿ƒè·³
- #21 leaveæ“ä½œè¯­ä¹‰å†²çªï¼ˆå·§å·§å·²ä¿®å¤ï¼‰

**ç¬¬äºŒé˜¶æ®µï¼ˆä¸‹å‘¨ï¼‰**:
- #2 æ¥å…¥çœŸå®Redis
- #5 é…ç½®ç»Ÿä¸€
- #6 ç§»é™¤ç¡¬ç¼–ç IP

**ç¬¬ä¸‰é˜¶æ®µï¼ˆåç»­ï¼‰**:
- #9 è®°å¿†é™åˆ¶ç»Ÿä¸€
- #10-14 ä»£ç è´¨é‡æ”¹è¿›

---

*Generated by å°å° - 2026-02-07*
